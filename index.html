<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ambient Music</title>

  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.3.5/Tone.js"></script>

  <style>
    summary::-webkit-details-marker { display:none; }
    .ios-scroll { -webkit-overflow-scrolling: touch; }
    .glass {
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    input[type="range"]{ accent-color:#0f172a; }
    .subtitle-fit{
      font-size: clamp(12px, 3.3vw, 14px);
      line-height: 1.7;
      letter-spacing: -0.015em;
      white-space: pre-line;
      word-break: keep-all;
      overflow-wrap: normal;
    }
    .guide-reveal{
      opacity: 0;
      transform: translateY(11px); /* UI TWEAK */
      transition: opacity 820ms cubic-bezier(0.22, 1, 0.36, 1), transform 820ms cubic-bezier(0.22, 1, 0.36, 1); /* UI TWEAK */
      will-change: opacity, transform;
    }
    .guide-reveal.is-visible{
      opacity: 1;
      transform: translateY(0);
    }

    .museum-type{ /* UI TWEAK */
      font-family: "Hiragino Mincho ProN","Yu Mincho","Noto Serif JP","HGS明朝E",serif;
      color: rgb(30 41 59);
    }
    .guide-caption{
      max-width: none; /* DESIGN UPDATE */
      width: 100%; /* DESIGN UPDATE */
      margin-inline: auto;
      color: rgb(30 41 59);
      font-size: clamp(13px, 1.2vw, 14px); /* DESIGN UPDATE */
      line-height: 2.08; /* DESIGN UPDATE */
      font-family: "Hiragino Mincho ProN","Yu Mincho","Noto Serif JP","HGS明朝E",serif;
      font-weight: 400;
      position: relative; /* DESIGN UPDATE */
      background: #fff; /* DESIGN UPDATE */
      padding: 0; /* DESIGN UPDATE */
      border: 0 !important; /* DESIGN UPDATE */
      outline: 0; /* DESIGN UPDATE */
      box-shadow: none !important; /* DESIGN UPDATE */
      isolation: isolate; /* DESIGN UPDATE */
    }
    .guide-caption-title{
      font-size: clamp(13px, 1.2vw, 14px); /* DESIGN UPDATE */
      letter-spacing: 0;
      color: rgb(30 41 59);
      font-weight: 400;
      margin-top: 0;
      margin-bottom: 0;
    }
    .rippleHint{position:relative;overflow:visible;background:#fff;} /* DESIGN UPDATE */
    .rippleHint::before,
    .rippleHint::after{ /* DESIGN UPDATE */
      content:"";
      position:absolute;
      pointer-events:none;
      z-index:0;
      width:340px;
      height:260px;
      filter: blur(0.6px);
      opacity:0.16;
      background: radial-gradient(closest-side, rgba(148,163,184,0.16), rgba(255,255,255,0));
      animation: watercolorBreath 32s ease-in-out infinite;
    }
    .rippleHint::before{left:-96px;top:-84px;} /* DESIGN UPDATE */
    .rippleHint::after{right:-88px;bottom:-82px;background: radial-gradient(closest-side, rgba(134,190,174,0.15), rgba(255,255,255,0));animation-delay:-11s;} /* DESIGN UPDATE */
    @keyframes watercolorBreath{ /* DESIGN UPDATE */
      0%,100%{transform:translate(0,0) scale(1);opacity:0.12;}
      50%{transform:translate(1px,-1px) scale(1.02);opacity:0.18;}
    }
    .rippleHint > *{position:relative;z-index:1;} /* DESIGN UPDATE */
    .caption-line{margin:0;} /* UI TWEAK */
    .caption-line + .caption-line{
      margin-top: 24px; /* UI TWEAK */
    }

    .guide-pages{ /* DESIGN UPDATE */
      height: min(68vh, 520px);
      overflow-y: auto;
      scroll-snap-type: y mandatory;
      scrollbar-width: none;
      -ms-overflow-style: none;
      position: relative;
      background: #fff; /* DESIGN UPDATE */
      padding-inline: 18px; /* DESIGN UPDATE */
      box-sizing: border-box; /* DESIGN UPDATE */
    }
    .guide-pages::-webkit-scrollbar{display:none;} /* UI TWEAK */
    .guide-page{ /* DESIGN UPDATE */
      min-height: 62vh;
      position: relative; /* DESIGN UPDATE */
      z-index: 1; /* DESIGN UPDATE */
      scroll-snap-align: start;
      display: grid;
      align-content: start;
      justify-items: center; /* DESIGN UPDATE */
      padding: 11.5vh 0 8vh; /* DESIGN UPDATE */
      box-sizing: border-box; /* DESIGN UPDATE */
      background: #fff; /* DESIGN UPDATE */
      border:0; /* DESIGN UPDATE */
      box-shadow:none; /* DESIGN UPDATE */
      outline:0; /* DESIGN UPDATE */
      overflow:hidden; /* DESIGN UPDATE */
      opacity:1; /* DESIGN UPDATE */
      transform: translateY(0); /* DESIGN UPDATE */
      transition: none; /* DESIGN UPDATE */
    }
    .guide-page.is-current{opacity:1;transform:translateY(0);} /* DESIGN UPDATE */
    .guide-page-text{opacity:0;transform:translateY(8px);} /* DESIGN UPDATE */
    .guide-page.is-current .guide-page-text{animation: captionReveal 10s cubic-bezier(0.16,1,0.3,1) forwards;} /* DESIGN UPDATE */
    @keyframes captionReveal{ /* DESIGN UPDATE */
      0%{opacity:0;transform:translateY(8px);}
      8%{opacity:0.25;transform:translateY(6px);}
      100%{opacity:1;transform:translateY(0);}
    }

    .guide-page::before,.guide-page::after{content:"";position:absolute;inset:0;pointer-events:none;z-index:0;filter: blur(0.6px);} /* DESIGN UPDATE */
    .guide-page[data-slide="0"]{background:#fff;} /* DESIGN UPDATE */
    .guide-page[data-slide="0"]::before{background:radial-gradient(320px 230px at 14% 18%, rgba(148,163,184,0.24), rgba(255,255,255,0));opacity:.24;} /* DESIGN UPDATE */
    .guide-page[data-slide="0"]::after{background:radial-gradient(300px 220px at 86% 84%, rgba(148,163,184,0.18), rgba(255,255,255,0));opacity:.18;} /* DESIGN UPDATE */

    .guide-page[data-slide="1"]{background:#fff;} /* DESIGN UPDATE */
    .guide-page[data-slide="1"]::before{background:radial-gradient(320px 230px at 14% 14%, rgba(134,190,174,0.24), rgba(255,255,255,0));opacity:.24;} /* DESIGN UPDATE */
    .guide-page[data-slide="1"]::after{background:radial-gradient(280px 210px at 88% 82%, rgba(148,163,184,0.16), rgba(255,255,255,0));opacity:.16;} /* DESIGN UPDATE */

    .guide-page[data-slide="2"]{background:#fff;} /* DESIGN UPDATE */
    .guide-page[data-slide="2"]::before{background:radial-gradient(320px 230px at 84% 14%, rgba(125,211,252,0.24), rgba(255,255,255,0));opacity:.24;} /* DESIGN UPDATE */
    .guide-page[data-slide="2"]::after{background:radial-gradient(260px 190px at 12% 84%, rgba(148,163,184,0.16), rgba(255,255,255,0));opacity:.16;} /* DESIGN UPDATE */

    .guide-page[data-slide="3"]{background:#fff;} /* DESIGN UPDATE */
    .guide-page[data-slide="3"]::before{background:radial-gradient(320px 230px at 12% 84%, rgba(250,204,21,0.23), rgba(255,255,255,0));opacity:.23;} /* DESIGN UPDATE */
    .guide-page[data-slide="3"]::after{background:radial-gradient(260px 190px at 84% 16%, rgba(148,163,184,0.16), rgba(255,255,255,0));opacity:.16;} /* DESIGN UPDATE */

    .guide-page[data-slide="4"]{background:#fff;} /* DESIGN UPDATE */
    .guide-page[data-slide="4"]::before{background:radial-gradient(320px 230px at 86% 84%, rgba(125,211,252,0.22), rgba(255,255,255,0));opacity:.22;} /* DESIGN UPDATE */
    .guide-page[data-slide="4"]::after{background:radial-gradient(280px 200px at 14% 16%, rgba(250,204,21,0.20), rgba(255,255,255,0));opacity:.20;} /* DESIGN UPDATE */

    .guide-page[data-slide="5"]{background:#fff;} /* DESIGN UPDATE */
    .guide-page[data-slide="5"]::before{background:radial-gradient(320px 230px at 14% 16%, rgba(148,163,184,0.24), rgba(255,255,255,0));opacity:.24;} /* DESIGN UPDATE */
    .guide-page[data-slide="5"]::after{background:radial-gradient(260px 190px at 88% 84%, rgba(148,163,184,0.16), rgba(255,255,255,0));opacity:.16;} /* DESIGN UPDATE */

    #guideTransitionLayer{position:absolute;inset:0;pointer-events:none;opacity:0;transform:scale(1);filter:blur(0);z-index:70;background:
      radial-gradient(240px 170px at 84% 18%, rgba(148,163,184,0.42), rgba(255,255,255,0) 62%),
      radial-gradient(260px 180px at 16% 84%, rgba(163,176,196,0.40), rgba(255,255,255,0) 66%),
      radial-gradient(220px 160px at 78% 86%, rgba(120,138,156,0.36), rgba(255,255,255,0) 64%),
      radial-gradient(220px 160px at 22% 22%, rgba(176,190,207,0.34), rgba(255,255,255,0) 64%), #fff;transition:opacity 2200ms cubic-bezier(0.16,1,0.3,1),transform 2200ms cubic-bezier(0.16,1,0.3,1),filter 2200ms cubic-bezier(0.16,1,0.3,1);} /* DESIGN UPDATE */
    #guideTransitionLayer.is-active{opacity:1;transform:scale(1.04);filter:blur(14px);} /* DESIGN UPDATE */

    .guide-page[data-slide="6"]{ /* DESIGN UPDATE */
      background:
        radial-gradient(210px 150px at 84% 18%, rgba(148,163,184,0.44), rgba(255,255,255,0) 62%),
        radial-gradient(230px 160px at 16% 84%, rgba(163,176,196,0.40), rgba(255,255,255,0) 64%),
        radial-gradient(180px 130px at 78% 86%, rgba(120,138,156,0.38), rgba(255,255,255,0) 64%),
        radial-gradient(200px 140px at 22% 22%, rgba(176,190,207,0.34), rgba(255,255,255,0) 62%),
        #fff;
    }
    .guide-page[data-slide="6"]::before,.guide-page[data-slide="6"]::after{background:none;} /* DESIGN UPDATE */
    .guide-page-text{ /* DESIGN UPDATE */
      position: relative; /* DESIGN UPDATE */
      z-index: 1; /* DESIGN UPDATE */
      margin: 0; /* DESIGN UPDATE */
      line-height: 1.45; /* DESIGN UPDATE */
      width: min(100%, 548px); /* DESIGN UPDATE */
      box-sizing: border-box; /* DESIGN UPDATE */
      padding-left: 24px; /* DESIGN UPDATE */
      margin-left: -12px; /* DESIGN UPDATE */
      color: rgb(30 41 59); /* DESIGN UPDATE */
      font-size: clamp(13px, 1.2vw, 14px); /* DESIGN UPDATE */
      font-weight: 400; /* DESIGN UPDATE */
    }
    .guide-page-text + .guide-page-text{margin-top: 10px;} /* DESIGN UPDATE */
    .guide-page-text{white-space: pre-line;word-break: keep-all;overflow-wrap: anywhere;} /* DESIGN UPDATE */
    .guide-indicator{ /* UI TWEAK */
      margin-top: 4px;
      display:flex;
      justify-content:center;
      gap:8px;
    }
    .guide-dot{ /* UI TWEAK */
      width: 5px;
      height: 5px;
      border-radius: 9999px;
      background: rgba(30,41,59,0.24); /* UI TWEAK */
      transition: background 320ms ease, transform 320ms ease, opacity 320ms ease; /* UI TWEAK */
      opacity: 0.34; /* UI TWEAK */
    }
    .guide-dot.is-active{background: rgba(30,41,59,0.62);opacity:0.82;transform: scale(1.18);animation: guideDotBreath 14s ease-in-out infinite;} /* UI TWEAK */
    @keyframes guideDotBreath{ /* UI TWEAK */
      0%,100%{opacity:0.55;}
      50%{opacity:0.85;}
    }
    .guide-overlay-fade{opacity:0;transform:translateY(8px);transition:opacity 2200ms cubic-bezier(0.16, 1, 0.3, 1), transform 2200ms cubic-bezier(0.16, 1, 0.3, 1);} /* DESIGN UPDATE */

    #settingsOverlay{opacity:0;pointer-events:none;transition:opacity 560ms cubic-bezier(0.16, 1, 0.3, 1);} /* DESIGN UPDATE */
    #settingsOverlay.is-open{opacity:1;pointer-events:auto;} /* DESIGN UPDATE */
    #settingsOverlay .settings-shell{opacity:0;transform:translateY(6px);transition:opacity 560ms cubic-bezier(0.16, 1, 0.3, 1), transform 560ms cubic-bezier(0.16, 1, 0.3, 1);} /* DESIGN UPDATE */
    #settingsOverlay.is-open .settings-shell{opacity:1;transform:translateY(0);} /* DESIGN UPDATE */
    @media (prefers-reduced-motion: reduce){
      .guide-reveal, .guide-reveal.is-visible{
        opacity: 1;
        transform: none;
        transition: none;
      }
      .rippleHint::before,.rippleHint::after,.guide-dot.is-active{animation:none !important;} /* UI TWEAK */
      .guide-page-text{opacity:1 !important;transform:none !important;transition:none !important;animation:none !important;} /* DESIGN UPDATE */
      #settingsOverlay,#settingsOverlay .settings-shell,.guide-overlay-fade,#guideTransitionLayer{transition:none !important;transform:none !important;filter:none !important;} /* DESIGN UPDATE */
    }
  </style>
</head>

<body class="min-h-screen text-slate-900">
  <main class="min-h-screen flex items-center justify-center p-4 sm:p-8">
    <section class="w-full max-w-xl">
      <div class="rounded-[32px] border border-slate-200/70 bg-white backdrop-blur-md shadow-[0_16px_46px_rgba(15,23,42,0.07)] overflow-hidden">
        <div class="px-5 sm:px-8 pt-7 pb-6">
          <div class="flex items-start justify-between gap-3">
            <h1 class="museum-type text-xl sm:text-2xl font-semibold tracking-tight">Ambient Music</h1> <!-- UI TWEAK -->
            <div class="text-right whitespace-nowrap shrink-0">
              <div class="text-xs tabular-nums text-slate-500">次回更新 <span id="countdown" class="font-semibold text-slate-800">—</span></div>
            </div>
          </div>
          <p class="subtitle-fit mt-2 text-slate-500">季節、天気、風のゆらぎ。
この瞬間の自然と呼吸を合わせ、音は静かに生まれていく。</p>

          <button id="btnToggle" class="mt-7 w-full rounded-[30px] px-6 py-8 transition active:scale-[0.99] bg-slate-900 text-white hover:bg-slate-800 shadow-[0_18px_40px_rgba(15,23,42,0.20)] relative overflow-hidden">
            <div class="flex items-center justify-center gap-4">
              <div class="grid place-items-center size-14 rounded-2xl bg-white/10 border border-white/20">
                <svg id="iconSvg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="opacity-95"><path d="M8 5v14l11-7z"></path></svg>
              </div>
              <div class="text-left">
                <div id="btnLabel" class="text-2xl font-semibold">Start</div>
                <div id="btnSub" class="text-xs text-white/80">タップで再生</div>
              </div>
            </div>
          </button>

          <div class="mt-5 rounded-2xl border border-slate-200/50 bg-white px-4 py-3 shadow-[0_1px_0_rgba(15,23,42,0.02)]">
            <div class="text-xs text-slate-500">現在の状態</div>
            <div id="statusMain" class="mt-1 text-base font-medium text-slate-800">夜の澄んだ空気、きらめき控えめ。</div>
            <div id="statusSub" class="hidden">—</div>
            <div id="statusChip" class="hidden">—</div>
            
          </div>
        </div>

        <div class="border-t border-slate-200/70 bg-[#fbfbfa]">
          <div class="px-6 sm:px-8 py-4 flex items-center justify-between gap-2">
            <button id="btnRefresh" class="px-4 py-2 rounded-2xl text-sm bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 active:scale-[0.99]">更新</button>
            <details id="settingsDetails" class="group">
              <summary class="list-none cursor-pointer select-none px-4 py-2 rounded-2xl text-sm bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 inline-flex items-center gap-2">
                詳細
                <span class="text-slate-400 group-open:rotate-180 transition">▾</span>
              </summary>
            </details>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="settingsOverlay" class="fixed inset-0 z-50 hidden">
    <div id="guideTransitionLayer" aria-hidden="true"></div> <!-- DESIGN UPDATE -->
    <div id="settingsBackdrop" class="absolute inset-0 bg-slate-900/10 backdrop-blur-[2px]"></div>
    <div class="settings-shell absolute inset-0 flex items-end sm:items-center justify-center p-3 sm:p-6"> <!-- DESIGN UPDATE -->
      <div class="w-full max-w-[760px] rounded-[30px] bg-white border border-slate-200/80 shadow-[0_20px_48px_rgba(15,23,42,0.12)] overflow-hidden">
        <div class="px-5 sm:px-6 pt-4 pb-3 border-b border-slate-200">
          <div class="flex items-center justify-between gap-3">
            <div class="text-sm font-semibold text-slate-800">詳細</div>
            <div class="flex items-center gap-2">
              <button id="btnAllAuto" class="hidden px-3 py-1.5 rounded-xl text-xs border border-slate-200 bg-white hover:bg-slate-50">All Auto</button> <!-- UI TWEAK -->
              <button id="btnCloseSettings" class="px-3 py-1.5 rounded-xl text-sm bg-slate-900 text-white hover:bg-slate-800">閉じる</button>
            </div>
          </div>
          <div class="mt-3 flex gap-2">
            <button data-tab="tabSettings" class="tabBtn flex-1 px-3 py-2 rounded-2xl text-sm border border-slate-200 bg-sky-50/60 text-slate-700">手動調整</button>
            <button data-tab="tabGuide" class="tabBtn flex-1 px-3 py-2 rounded-2xl text-sm border border-slate-200 bg-white text-slate-700 hover:bg-slate-50">音の設計思想</button>
          </div>
        </div>

        <div class="px-5 sm:px-6 py-4 max-h-[74vh] overflow-y-auto ios-scroll">
          <section id="tabSettings" class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs">
              <div class="rounded-2xl border border-slate-200 bg-white px-4 py-3"><div class="text-slate-500">季節</div><div id="envSeason" class="mt-1 text-sm font-medium text-slate-800">Auto</div></div>
              <div class="rounded-2xl border border-slate-200 bg-white px-4 py-3"><div class="text-slate-500">時間</div><div id="envTime" class="mt-1 text-sm font-medium text-slate-800">Auto</div></div>
              <div class="rounded-2xl border border-slate-200 bg-white px-4 py-3"><div class="text-slate-500">天気</div><div id="envWeather" class="mt-1 text-sm font-medium text-slate-800">Auto</div></div>
              <div class="rounded-2xl border border-slate-200 bg-white px-4 py-3"><div class="text-slate-500">風 / UV</div><div id="envWindUv" class="mt-1 text-sm font-medium text-slate-800">—</div></div>
            </div>

            <div class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="text-sm font-semibold text-slate-800">現在の音楽</div>
              <div class="mt-3 grid grid-cols-2 sm:grid-cols-5 gap-2">
                <div class="rounded-xl border border-slate-200 bg-slate-50 p-2"><div class="text-[10px] text-slate-500">Key</div><div id="metricKey" class="text-sm font-medium text-slate-800 mt-1">—</div></div>
                <div class="rounded-xl border border-slate-200 bg-slate-50 p-2"><div class="text-[10px] text-slate-500">Tempo</div><div id="metricTempo" class="text-sm font-medium text-slate-800 mt-1">—</div></div>
                <div class="rounded-xl border border-slate-200 bg-slate-50 p-2"><div class="text-[10px] text-slate-500">Brightness</div><div id="metricBrightness" class="text-sm font-medium text-slate-800 mt-1">—</div></div>
                <div class="rounded-xl border border-slate-200 bg-slate-50 p-2"><div class="text-[10px] text-slate-500">Sparkle</div><div id="metricSparkle" class="text-sm font-medium text-slate-800 mt-1">—</div></div>
                <div class="rounded-xl border border-slate-200 bg-slate-50 p-2"><div class="text-[10px] text-slate-500">Reverb</div><div id="metricReverb" class="text-sm font-medium text-slate-800 mt-1">—</div></div>
              </div>
              <div id="envModeBadge" class="hidden" aria-hidden="true"></div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <div><div class="text-xs text-slate-500 mb-1">季節</div><select id="seasonSel" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm"><option value="auto">Auto</option><option value="spring">春</option><option value="summer">夏</option><option value="autumn">秋</option><option value="winter">冬</option></select></div>
              <div><div class="text-xs text-slate-500 mb-1">時間</div><select id="timeSel" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm"><option value="auto">Auto</option><option value="morning">朝</option><option value="day">昼</option><option value="evening">夕</option><option value="night">夜</option><option value="late">深夜</option></select></div>
              <div><div class="text-xs text-slate-500 mb-1">天気</div><select id="weatherSel" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm"><option value="auto">Auto</option><option value="clear">晴れ</option><option value="other">曇り</option><option value="rain">雨</option></select></div>
            </div>

            <div class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="text-sm font-semibold text-slate-800">自然音</div>
              <div class="mt-3 space-y-4">
                <div><div class="flex items-center justify-between"><div class="text-xs text-slate-500">鳥</div><div id="birdVal" class="text-xs font-medium text-slate-700">50</div></div><input id="birdMix" type="range" min="0" max="100" step="1" class="w-full" /></div>
                <div><div class="flex items-center justify-between"><div class="text-xs text-slate-500">風</div><div id="windVal" class="text-xs font-medium text-slate-700">50</div></div><input id="windMix" type="range" min="0" max="100" step="1" class="w-full" /></div>
                <div><div class="flex items-center justify-between"><div class="text-xs text-slate-500">水</div><div id="waterVal" class="text-xs font-medium text-slate-700">50</div></div><input id="waterMix" type="range" min="0" max="100" step="1" class="w-full" /></div>
              </div>
            </div>

            <div class="rounded-2xl border border-slate-200 bg-white p-4">
              <div class="text-sm font-semibold text-slate-800">音楽ニュアンス</div>
              <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div><div class="flex items-center justify-between"><div class="text-xs text-slate-500">きらめき</div><span id="nuanceSparkleMode" class="text-[10px] px-2 py-0.5 rounded-full border border-slate-200">Auto</span></div><input id="nuanceSparkle" type="range" min="0" max="100" value="50" class="w-full" /></div>
                <div><div class="flex items-center justify-between"><div class="text-xs text-slate-500">スピード</div><span id="nuanceSpeedMode" class="text-[10px] px-2 py-0.5 rounded-full border border-slate-200">Auto</span></div><input id="nuanceSpeed" type="range" min="0" max="100" value="50" class="w-full" /></div>
                <div><div class="flex items-center justify-between"><div class="text-xs text-slate-500">明るさ</div><span id="nuanceBrightMode" class="text-[10px] px-2 py-0.5 rounded-full border border-slate-200">Auto</span></div><input id="nuanceBright" type="range" min="0" max="100" value="50" class="w-full" /></div>
                <div><div class="flex items-center justify-between"><div class="text-xs text-slate-500">余韻</div><span id="nuanceReverbMode" class="text-[10px] px-2 py-0.5 rounded-full border border-slate-200">Auto</span></div><input id="nuanceReverb" type="range" min="0" max="100" value="50" class="w-full" /></div>
              </div>
            </div>
          </section>

          <section id="tabGuide" class="hidden">
            <div class="guide-caption rippleHint museum-type"> <!-- DESIGN UPDATE -->
              <div id="guidePages" class="guide-pages"> <!-- DESIGN UPDATE -->
                <article class="guide-page is-current" data-page="1" data-slide="0"> <!-- UI TWEAK -->
                  <p class="guide-page-text guide-caption-title">Ambient Music</p>
                  <p class="guide-page-text guide-caption-title">― 自然と呼吸を合わせる音の設計 ―</p>
                </article>

                <article class="guide-page" data-page="2" data-slide="1"> <!-- UI TWEAK -->
                  <p class="guide-page-text">季節、時間、天候、風、UV。</p>
                  <p class="guide-page-text">このアプリは、自然の値をそのまま鳴らす設計ではありません。</p>
                </article>

                <article class="guide-page" data-page="3" data-slide="2"> <!-- UI TWEAK -->
                  <p class="guide-page-text">受け取った環境データは、いったん整えられます。</p>
                  <p class="guide-page-text">そして調性、テンポ、明るさ、きらめき、余韻へと翻訳されます。</p>
                </article>

                <article class="guide-page" data-page="4" data-slide="3"> <!-- UI TWEAK -->
                  <p class="guide-page-text">和音は同一キーの三和音のみ。</p>
                  <p class="guide-page-text">I / IV / V / vi を中心に、呼吸するように重なります。</p>
                  <p class="guide-page-text">不安定さを避け、空間に溶ける輪郭を保ちます。</p>
                </article>

                <article class="guide-page" data-page="5" data-slide="4"> <!-- UI TWEAK -->
                  <p class="guide-page-text">晴れた昼は、わずかに明るく。</p>
                  <p class="guide-page-text">雨の夜は、余韻が静かに深く。</p>
                  <p class="guide-page-text">風が強い日は、きらめきが少しだけ揺れます。</p>
                </article>

                <article class="guide-page" data-page="6" data-slide="5"> <!-- UI TWEAK -->
                  <p class="guide-page-text">変化は控えめです。</p>
                  <p class="guide-page-text">けれど確実に、いまの空気をまといます。</p>
                </article>

                <article class="guide-page" data-page="7" data-slide="6"> <!-- DESIGN UPDATE -->
                  <p class="guide-page-text">同じ音は二度と鳴らない。</p>
                  <p class="guide-page-text">再生するたび、</p>
                  <p class="guide-page-text">この瞬間の自然が、音になります。</p>
                </article>
              </div>

              <div id="guideIndicator" class="guide-indicator" aria-hidden="true"> <!-- UI TWEAK -->
                <span class="guide-dot is-active"></span>
                <span class="guide-dot"></span>
                <span class="guide-dot"></span>
                <span class="guide-dot"></span>
                <span class="guide-dot"></span>
                <span class="guide-dot"></span>
                <span class="guide-dot"></span>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>


<script>
const OPEN_METEO_URL = "https://api.open-meteo.com/v1/forecast";
const AUTO_UPDATE_MS = 5 * 60 * 1000;
let nextUpdateAt = Date.now() + AUTO_UPDATE_MS;
let isRefreshingWeather = false;
const WEATHER_RETRY_MS = 60 * 1000;
function describeWeather(code){if(code===0)return"快晴";if([1,2].includes(code))return"晴れ/薄曇り";if(code===3)return"くもり";if([45,48].includes(code))return"霧";if([51,53,55,56,57].includes(code))return"霧雨";if([61,63,65,66,67].includes(code))return"雨";if([71,73,75,77].includes(code))return"雪";if([80,81,82].includes(code))return"にわか雨";if([95,96,99].includes(code))return"雷雨";return"不明";}
function weatherCategoryFromCode(code){if(code===0||[1,2].includes(code))return"clear";if([61,63,65,66,67,80,81,82,51,53,55,56,57,95,96,99].includes(code))return"rain";return"other";}
async function fetchWeatherByCoords(lat,lon){const url=new URL(OPEN_METEO_URL);url.searchParams.set("latitude",lat);url.searchParams.set("longitude",lon);url.searchParams.set("current","weather_code,wind_speed_10m");url.searchParams.set("daily","uv_index_max");url.searchParams.set("timezone","auto");const res=await fetch(url.toString());if(!res.ok)throw new Error("天気取得に失敗しました");const data=await res.json();const code=data?.current?.weather_code;const wind=data?.current?.wind_speed_10m;const uvArr=data?.daily?.uv_index_max;const uv=Array.isArray(uvArr)?uvArr[0]:null;if(typeof code!=="number"||typeof wind!=="number")throw new Error("天気データ形式が想定と違います");return {code,wind,uv:(typeof uv==="number"?uv:null)};}
function getCurrentPosition(){return new Promise((resolve,reject)=>{if(!navigator.geolocation)return reject(new Error("このブラウザは位置情報に対応していません"));navigator.geolocation.getCurrentPosition(resolve,reject,{enableHighAccuracy:false,timeout:8000,maximumAge:60_000});});}
let wakeLock=null; async function requestWakeLock(){try{if(!("wakeLock" in navigator))return;wakeLock=await navigator.wakeLock.request("screen");wakeLock.addEventListener("release",()=>{wakeLock=null;});}catch(e){}} async function releaseWakeLock(){try{if(wakeLock)await wakeLock.release();}catch(e){}wakeLock=null;}
// [STABILITY FIX] lightweight runtime guards and recovery state
let lastSoundAt=Date.now();
let audioRecoveryInFlight=false;
let lastRecoveryAttemptAt=0;
let lastRebuildAttemptAt=0;
let lastHardRecoveryAt=0;
const RECOVERY_COOLDOWN_MS=1000;
const REBUILD_COOLDOWN_MS=20000;
const HARD_RECOVERY_COOLDOWN_MS=120000;

// STABILITY FIX: layer-level sound activity trackers for silence detection/recovery
function markSoundActivity(){lastSoundAt=Date.now();}
const layerLastSoundAt={sparkle:Date.now(),bird:Date.now(),wind:Date.now(),water:Date.now(),melody:Date.now(),pad:Date.now(),harmony:Date.now()};
const layerLastRecoveryAt={sparkle:0,bird:0,wind:0,water:0,melody:0,pad:0,harmony:0};
const LAYER_SILENCE_MS={sparkle:120000,bird:180000,wind:240000,water:240000,melody:180000,pad:300000,harmony:180000};
const LAYER_RECOVERY_COOLDOWN_MS=120000;
let lastAnyLayerRecoveryAt=0;
const GLOBAL_LAYER_RECOVERY_COOLDOWN_MS=60000;
let isRecovering=false;
let audioStateWatcherBound=false;
let userGestureResumeBound=false;
let lastForceResumeAt=0;
function markLayerSound(layer){const now=Date.now();layerLastSoundAt[layer]=now;lastSoundAt=now;}
function trackedTriggerAttackRelease(target,...args){markSoundActivity();return target.triggerAttackRelease(...args);}
function trackedTriggerAttackReleaseLayer(layer,target,...args){markLayerSound(layer);return target.triggerAttackRelease(...args);}

// [STABILITY FIX] robust context/transport resume for iOS Safari + background restores
async function resumeAudioIfNeeded(reason="unknown",force=false){
  try{
    if(audioRecoveryInFlight)return false;
    const now=Date.now();
    if(!force&&now-lastRecoveryAttemptAt<RECOVERY_COOLDOWN_MS)return false;
    audioRecoveryInFlight=true;
    lastRecoveryAttemptAt=now;
    const ctx=Tone.getContext?.().rawContext||Tone.context?.rawContext||Tone.context;
    const state=ctx?.state;
    if(state&&state!=="running"){
      try{await Tone.start();}catch(e){}
      try{await ctx.resume();}catch(e){}
    }
    if(isRunning&&Tone.Transport.state!=="started"){
      try{Tone.Transport.start();}catch(e){}
    }
    return true;
  }catch(e){
    return false;
  }finally{
    audioRecoveryInFlight=false;
  }
}

function bindAudioContextStateWatcher(){
  if(audioStateWatcherBound)return;
  const ctx=Tone.getContext?.().rawContext||Tone.context?.rawContext||Tone.context;
  if(!ctx||!ctx.addEventListener)return;
  ctx.addEventListener("statechange",async()=>{
    if(!isRunning)return;
    if(ctx.state!=="suspended")return;
    const now=Date.now();
    if(now-lastForceResumeAt<500)return;
    lastForceResumeAt=now;
    try{await resumeAudioIfNeeded("statechange",true);}catch(e){}
  });
  audioStateWatcherBound=true;
}

function bindUserGestureResume(){
  if(userGestureResumeBound)return;
  const onGesture=async()=>{
    if(!isRunning)return;
    try{await resumeAudioIfNeeded("user-gesture",true);}catch(e){}
  };
  ["pointerdown","touchstart","keydown","mousedown"].forEach(evt=>document.addEventListener(evt,onGesture,{passive:true}));
  userGestureResumeBound=true;
}

// [STABILITY FIX] focus/visibility recovery hooks (throttled by resumeAudioIfNeeded)
document.addEventListener("visibilitychange",async()=>{if(document.visibilityState==="visible"&&isRunning){await resumeAudioIfNeeded("visibilitychange");await requestWakeLock();}});
window.addEventListener("pageshow",async()=>{if(isRunning){await resumeAudioIfNeeded("pageshow");}});
window.addEventListener("focus",async()=>{if(isRunning){await resumeAudioIfNeeded("focus");}});
// STABILITY FIX: keep scheduler callbacks alive even if one tick throws
function safeLoopCallback(name,fn){return (time)=>{try{fn(time);}catch(e){console.warn(`[${name}] loop callback error`,e);}};}
function configureToneRuntime(){try{if(Tone.context){Tone.context.lookAhead=0.5;if(Tone.context.updateInterval)Tone.context.updateInterval=0.1;}const ctx=Tone.getContext?.().rawContext||Tone.context?.rawContext||Tone.context;if(ctx&&typeof ctx.latencyHint!=="undefined"){try{ctx.latencyHint="playback";}catch(e){}}}catch(e){}}
const MIX_KEY="ambientMix_v1"; const mixState={bird:50,wind:50,water:50};
function clamp(n,min,max){return Math.max(min,Math.min(max,n));} function randomBetween(min,max){return min+Math.random()*(max-min);} function randInt(min,max){return Math.floor(min+Math.random()*(max-min+1));} function choose(arr){return arr[Math.floor(Math.random()*arr.length)];}
function loadMix(){try{const raw=localStorage.getItem(MIX_KEY);if(!raw)return;const obj=JSON.parse(raw);if(typeof obj?.bird==="number")mixState.bird=clamp(Math.round(obj.bird),0,100);if(typeof obj?.wind==="number")mixState.wind=clamp(Math.round(obj.wind),0,100);if(typeof obj?.water==="number")mixState.water=clamp(Math.round(obj.water),0,100);}catch(e){}}
function saveMix(){try{localStorage.setItem(MIX_KEY,JSON.stringify(mixState));}catch(e){}}
function mixMultiplierFromPercent(p){const x=clamp(p,0,100)/50;return clamp(x,0,2.0);} function getMix(){return {birdMul:mixMultiplierFromPercent(mixState.bird),windMul:mixMultiplierFromPercent(mixState.wind),waterMul:mixMultiplierFromPercent(mixState.water),birdPct:mixState.bird,windPct:mixState.wind,waterPct:mixState.water};}
function syncMixUI(){const b=document.getElementById("birdMix"),w=document.getElementById("windMix"),wa=document.getElementById("waterMix"),bv=document.getElementById("birdVal"),wv=document.getElementById("windVal"),wav=document.getElementById("waterVal");if(!b||!w||!wa||!bv||!wv||!wav)return;b.value=String(mixState.bird);w.value=String(mixState.wind);wa.value=String(mixState.water);bv.textContent=String(mixState.bird);wv.textContent=String(mixState.wind);wav.textContent=String(mixState.water);} function onMixChange(){syncMixUI();saveMix();if(isRunning){const r=applyParams();const now=Tone.now();if(windGain)windGain.gain.setValueAtTime(Math.max(0.000001,windBaseLevel(r)),now);if(waterGain)waterGain.gain.setValueAtTime(Math.max(0.000001,waterBaseLevel(r)),now);}}
function autoTimeBlock(){const h=new Date().getHours();if(h>=5&&h<10)return"morning";if(h>=10&&h<16)return"day";if(h>=16&&h<19)return"evening";if(h>=19&&h<24)return"night";return"late";} function autoSeason(){const m=new Date().getMonth()+1;if(m>=3&&m<=5)return"spring";if(m>=6&&m<=8)return"summer";if(m>=9&&m<=11)return"autumn";return"winter";}
function setStatus(main,sub="—"){const a=document.getElementById("statusMain"),b=document.getElementById("statusSub");if(!a||!b)return;a.textContent=(sub&&sub!=="—")?sub:main;b.textContent="";} function setStatusChip(text="—"){const el=document.getElementById("statusChip");if(el)el.textContent=text;}
function applyWhiteByTime(time){const map={morning:["from-sky-50","via-white","to-slate-100"],day:["from-white","via-white","to-slate-100"],evening:["from-rose-50","via-stone-50","to-zinc-100"],night:["from-slate-100","via-slate-50","to-slate-200"],late:["from-slate-100","via-slate-50","to-slate-200"]};const [a,b,c]=map[time]||map.day;const cat=weatherCategoryFromCode(lastWeather.code);const uv=(typeof lastWeather.uv==="number")?clamp(lastWeather.uv/11,0,1):0;const rainTint=(cat==="rain")?" saturate-[0.96] brightness-[0.985]":"";const uvTint=(uv>0.55)?" saturate-[1.02]":"";document.body.className=`min-h-screen text-slate-900 bg-gradient-to-b ${a} ${b} ${c}${rainTint}${uvTint}`;}
function setMediaSessionMetadata(text){if(!("mediaSession" in navigator))return;try{navigator.mediaSession.metadata=new MediaMetadata({title:"Ambient Music",artist:text,album:"Nature Sync"});navigator.mediaSession.setActionHandler("play",async()=>{if(!isRunning)await start();});navigator.mediaSession.setActionHandler("pause",()=>{if(isRunning)stop();});}catch(e){}}
function updatePlaybackState(){if(!("mediaSession" in navigator))return;try{navigator.mediaSession.playbackState=isRunning?"playing":"paused";}catch(e){}}
let isRunning=false;
let playbackWatchdogId=null;
let lastTransportSeconds=0;
let lastTransportCheckAt=0;
let silentRecoveryCount=0; // [STABILITY FIX]
let isRebuildingLoops=false;
let masterReverb, masterComp, masterLimiter;
let filter, airHighpass, airChorus;
let sparkle, crystalLead, lowLead, lowDrone, bellSynth, chimeSynth, stringEnsemble, stringPad, padGain; let bird,birdFilter,birdTremolo; let windNoise,windFilter,windGain; let waterNoise,waterFilter,waterGain;
let sparkleMulti=null,sparkleAutoPanner=null,sparkleHitPanner=null;
let lastSparkleDelayRebuildAt=0;
let sparkleLoop,birdLoop,windLoop,waterLoop,melodyLoop,lowMelodyLoop,padLoop,crystalHarmonyLoop,stringHarmonyLoop,lowResonanceLoop,bellLoop,chimeLoop,chordEventId=null;
let harmonySlots=null,harmonySlotIndex=0;
let lastWeather={code:0,wind:0,uv:null}; let lastRoot=null;
const SEASON_SOUND_PROFILE={spring:{brightness:0.1,padAttack:1.06,shimmer:0.22,calm:0.1},summer:{brightness:0.18,padAttack:0.94,shimmer:0.30,calm:0.02},autumn:{brightness:-0.06,padAttack:1.12,shimmer:0.14,calm:0.18},winter:{brightness:0.05,padAttack:1.16,shimmer:0.26,calm:0.24}};
const TIME_SOUND_PROFILE={morning:{density:0.08,space:0.08,brightness:0.10},day:{density:0.14,space:0,brightness:0.15},evening:{density:-0.04,space:0.14,brightness:-0.02},night:{density:-0.12,space:0.20,brightness:-0.08},late:{density:-0.18,space:0.28,brightness:-0.12}};
const WEATHER_SOUND_PROFILE={clear:{brightness:0.20,wet:-0.05,decay:-1.8,reflect:0.22},rain:{brightness:-0.14,wet:0.08,decay:2.2,reflect:-0.10},other:{brightness:0,wet:0,decay:0,reflect:0}};
async function ensureAudioGraph(){if(sparkle)return;masterReverb=new Tone.Reverb({decay:14.5,wet:0.42});if(masterReverb.generate){try{await masterReverb.generate();}catch(e){}}masterReverb.toDestination();masterComp=new Tone.Compressor({threshold:-20,ratio:2.8,attack:0.008,release:0.24}).connect(masterReverb);masterLimiter=new Tone.Limiter(-0.6).connect(masterComp);airChorus=new Tone.Chorus({frequency:0.18,delayTime:3.2,depth:0.12,spread:120,wet:0.16}).start();airHighpass=new Tone.Filter({type:"highpass",frequency:90,rolloff:-12}).connect(airChorus);filter=new Tone.Filter({type:"lowpass",frequency:1900,rolloff:-12}).connect(airHighpass);airChorus.connect(masterLimiter);sparkleAutoPanner=new Tone.AutoPanner({frequency:0.10,depth:0.85,wet:1.0}).start();sparkleHitPanner=new Tone.Panner(0);sparkleAutoPanner.connect(sparkleHitPanner);sparkleHitPanner.connect(filter);sparkle=new Tone.FMSynth({oscillator:{type:"triangle"},modulation:{type:"sine"},harmonicity:2.0,modulationIndex:2.8,envelope:{attack:0.008,decay:0.12,sustain:0,release:1.35},modulationEnvelope:{attack:0.01,decay:0.16,sustain:0,release:0.8}});sparkle.volume.value=-12;crystalLead=new Tone.FMSynth({oscillator:{type:"triangle"},modulation:{type:"sine"},harmonicity:2.4,modulationIndex:1.8,envelope:{attack:0.35,decay:1.2,sustain:0.25,release:4.8},modulationEnvelope:{attack:0.25,decay:1.1,sustain:0.12,release:2.6}}).connect(filter);crystalLead.volume.value=-18;lowLead=new Tone.Synth({oscillator:{type:"triangle"},envelope:{attack:0.22,decay:0.9,sustain:0.25,release:3.8}}).connect(filter);lowLead.volume.value=-19;lowDrone=new Tone.MonoSynth({oscillator:{type:"sine"},filter:{Q:1.6,type:"lowpass",rolloff:-12},envelope:{attack:1.4,decay:0.8,sustain:0.62,release:6.8},filterEnvelope:{attack:1.1,decay:1.2,sustain:0.35,release:5.5,baseFrequency:70,octaves:2.1}}).connect(filter);lowDrone.volume.value=-20;bellSynth=new Tone.MetalSynth({frequency:380,envelope:{attack:0.001,decay:1.4,release:2.4},harmonicity:3.2,modulationIndex:22,resonance:1300,octaves:1.8}).connect(filter);bellSynth.volume.value=-21;chimeSynth=new Tone.FMSynth({oscillator:{type:"sine"},modulation:{type:"triangle"},harmonicity:2.9,modulationIndex:2.6,envelope:{attack:0.002,decay:0.7,sustain:0.0,release:2.8},modulationEnvelope:{attack:0.01,decay:0.5,sustain:0.0,release:1.7}}).connect(filter);chimeSynth.volume.value=-23;stringEnsemble=new Tone.PolySynth(Tone.AMSynth,{harmonicity:1.6,oscillator:{type:"triangle"},envelope:{attack:1.8,decay:0.9,sustain:0.72,release:8.5},modulation:{type:"sine"},modulationEnvelope:{attack:0.4,decay:0.7,sustain:0.3,release:1.8}}).connect(filter);stringEnsemble.volume.value=-21;padGain=new Tone.Gain(0.000001).connect(filter);stringPad=new Tone.PolySynth(Tone.Synth,{oscillator:{type:"triangle"},envelope:{attack:3.2,decay:1.6,sustain:0.86,release:14.0}}).connect(padGain);stringPad.volume.value=-19;birdTremolo=new Tone.Tremolo({frequency:9,depth:0.65,wet:1.0}).start();birdFilter=new Tone.Filter({type:"bandpass",frequency:2300,Q:6});bird=new Tone.Synth({oscillator:{type:"sine"},envelope:{attack:0.004,decay:0.07,sustain:0,release:0.17}});bird.chain(birdTremolo,birdFilter,filter);bird.volume.value=-17;windNoise=new Tone.Noise("pink").start();windFilter=new Tone.Filter({type:"bandpass",frequency:420,Q:0.9});windGain=new Tone.Gain(0.000001);windNoise.chain(windFilter,windGain,filter);waterNoise=new Tone.Noise("brown").start();waterFilter=new Tone.Filter({type:"lowpass",frequency:900,rolloff:-12});waterGain=new Tone.Gain(0.000001);waterNoise.chain(waterFilter,waterGain,filter);if(!harmonySlots){harmonySlots=[0,1].map(()=>{const g=new Tone.Gain(0.000001).connect(filter);const s=new Tone.PolySynth(Tone.FMSynth,{oscillator:{type:"triangle"},modulation:{type:"sine"},harmonicity:1.5,modulationIndex:1.4,envelope:{attack:2.4,decay:0.7,sustain:0.8,release:18},modulationEnvelope:{attack:0.4,decay:0.8,sustain:0.3,release:3.2}}).connect(g);s.volume.value=-15;return {synth:s,gain:g};});}}
function disposeToneNode(node){if(!node)return;try{node.dispose();}catch(e){}}
function disposeAudioGraphForRecovery(){
  clearHarmonyScheduler();
  [sparkleLoop,birdLoop,windLoop,waterLoop,melodyLoop,lowMelodyLoop,padLoop,crystalHarmonyLoop,stringHarmonyLoop,lowResonanceLoop,bellLoop,chimeLoop].forEach(loop=>{if(!loop)return;try{loop.stop(0);}catch(e){}disposeToneNode(loop);});
  sparkleLoop=birdLoop=windLoop=waterLoop=melodyLoop=lowMelodyLoop=padLoop=crystalHarmonyLoop=stringHarmonyLoop=lowResonanceLoop=bellLoop=chimeLoop=null;

  if(sparkleMulti){(sparkleMulti.tapNodes||[]).forEach(disposeToneNode);disposeToneNode(sparkleMulti.input);disposeToneNode(sparkleMulti.merger);sparkleMulti=null;}lastSparkleDelayRebuildAt=0;

  if(harmonySlots){harmonySlots.forEach(slot=>{disposeToneNode(slot?.synth);disposeToneNode(slot?.gain);});}
  harmonySlots=null;harmonySlotIndex=0;

  [sparkle,crystalLead,lowLead,lowDrone,bellSynth,chimeSynth,stringEnsemble,stringPad,padGain,bird,birdFilter,birdTremolo,windNoise,windFilter,windGain,waterNoise,waterFilter,waterGain,sparkleAutoPanner,sparkleHitPanner,filter,airHighpass,airChorus,masterLimiter,masterComp,masterReverb].forEach(disposeToneNode);
  sparkle=crystalLead=lowLead=lowDrone=bellSynth=chimeSynth=stringEnsemble=stringPad=padGain=bird=birdFilter=birdTremolo=windNoise=windFilter=windGain=waterNoise=waterFilter=waterGain=sparkleAutoPanner=sparkleHitPanner=filter=airHighpass=airChorus=masterLimiter=masterComp=masterReverb=null;
}

function keyFromSeason(season){if(season==="spring")return"C";if(season==="summer")return"D";if(season==="autumn")return"Eb";if(season==="winter")return"A";return"C";} function chordChoicesForKey(key){const map={"C":["C4","F4","G4","A4"],"D":["D4","G4","A4","B4"],"Eb":["Eb4","Ab4","Bb4","C5"],"A":["A3","D4","E4","F#4"]};return map[key]||map["C"];}
function triad(rootNote){const r=Tone.Frequency(rootNote);return [r.toNote(),r.transpose(4).toNote(),r.transpose(7).toNote()];}
function sparkleScale(key,weatherCat,time){const major={"C":["C5","D5","E5","F5","G5","A5","B5","C6"],"D":["D5","E5","F#5","G5","A5","B5","C#6","D6"],"Eb":["Eb5","F5","G5","Ab5","Bb5","C6","D6","Eb6"],"A":["A4","B4","C#5","D5","E5","F#5","G#5","A5"]};const pent={"C":["C5","D5","E5","G5","A5","C6"],"D":["D5","E5","F#5","A5","B5","D6"],"Eb":["Eb5","F5","G5","Bb5","C6","Eb6"],"A":["A4","B4","C#5","E5","F#5","A5"]};const usePent=(weatherCat==="rain")||(time==="night"||time==="late");return usePent?(pent[key]||pent["C"]):(major[key]||major["C"]);}function melodyScaleForKey(key){const map={"C":["C4","D4","E4","G4","A4","C5","E5"],"D":["D4","E4","F#4","A4","B4","D5","F#5"],"Eb":["Eb4","F4","G4","Bb4","C5","Eb5","G5"],"A":["A3","B3","C#4","E4","F#4","A4","C#5"]};return map[key]||map["C"];}function lowMelodyScaleForKey(key){const map={"C":["C3","E3","G3","A3","C4","E4"],"D":["D3","F#3","A3","B3","D4","F#4"],"Eb":["Eb3","G3","Bb3","C4","Eb4","G4"],"A":["A2","C#3","E3","F#3","A3","C#4"]};return map[key]||map["C"];}function melodyDuration(r){let d=randomBetween(1.8,4.8);if(r.time==="night"||r.time==="late")d*=1.25;if(r.weatherCat==="clear")d*=0.9;return clamp(d,1.4,6.8);}
function getEnv(){const seasonSel=document.getElementById("seasonSel").value,timeSel=document.getElementById("timeSel").value,weatherSel=document.getElementById("weatherSel").value;const season=(seasonSel==="auto")?autoSeason():seasonSel;const time=(timeSel==="auto")?autoTimeBlock():timeSel;const weatherCat=(weatherSel==="auto")?weatherCategoryFromCode(lastWeather.code):weatherSel;return {season,time,weatherCat};}
function prettyTimeLabel(t){if(t==="morning")return"朝";if(t==="day")return"昼";if(t==="evening")return"夕";if(t==="night")return"夜";if(t==="late")return"深夜";if(t==="spring")return"春";if(t==="summer")return"夏";if(t==="autumn")return"秋";if(t==="winter")return"冬";return t;} function prettyWeatherLabel(w){if(w==="clear")return"晴れ";if(w==="rain")return"雨";if(w==="other")return"曇り";return w;}
function isDayTimeBlock(time){return(time==="day"||time==="morning"||time==="evening");}
function moodLine(env,windNorm){ // UI TWEAK
  const wind=clamp(lastWeather.wind??0,0,30);
  const uvRaw=(typeof lastWeather.uv==="number")?lastWeather.uv:null;
  const uvDay=(uvRaw!==null&&(env.time==="morning"||env.time==="day"||env.time==="evening"))?uvRaw:0;
  const windBand=(wind<1.2)?"calm":(wind<3.5)?"breeze":(wind<7)?"windy":"strong";

  if(env.time==="morning"){
    const byWeather={
      clear:["朝の光がやわらかく差し、空気は澄んでいる。","静かな朝、透明な余韻が穏やかに広がる。"],
      rain:["朝の雨に輪郭がなじみ、余韻は静かに滲む。","湿った朝の空気に、やわらかな残響が重なる。"],
      other:["朝の空気は軽く、端正な響きがそっと並ぶ。","穏やかな朝の景色に、淡い奥行きが宿る。"]
    };
    return choose(byWeather[env.weatherCat]||byWeather.other);
  }

  if(env.time==="day"){
    if(env.weatherCat==="clear"&&uvDay>=7){
      return choose(["光の密度が高く、乾いた余韻がすっと伸びる。","明るい空気に、透明な反射が細く差し込む。"]);
    }
    const dayByWeather={
      clear:["昼の澄んだ空気に、きらめきが静かに重なる。","明るい景色の中で、余韻は軽やかに保たれる。"],
      rain:["昼の雨は輪郭をやわらげ、響きはしっとり続く。","湿度を帯びた空気に、やさしい余白が生まれる。"],
      other:["中庸な昼の空気に、整った響きが穏やかに漂う。","落ち着いた明るさで、透明な層が重なっていく。"]
    };
    return choose(dayByWeather[env.weatherCat]||dayByWeather.other);
  }

  if(env.time==="evening"){
    const eveByWeather={
      clear:["夕方の光は穏やかで、余韻は静かに沈み込む。","淡い陰影の中で、透明な響きがゆるやかに残る。"],
      rain:["夕方の雨が空気を丸め、残響はやわらかく続く。","濡れた景色に寄り添い、余韻が静かに滲む。"],
      other:["夕方の空気は落ち着き、響きの輪郭が整っていく。","静かな陰影の中で、層の深さがゆっくり増す。"]
    };
    return choose(eveByWeather[env.weatherCat]||eveByWeather.other);
  }

  if(env.time==="night"){
    const nightByWind={
      calm:["夜の静けさに、余韻が穏やかに漂う。","澄んだ夜気の中で、響きが静かに広がる。"],
      breeze:["夜の空気に軽い揺らぎが混じり、余韻は上品に続く。","静かな夜、淡いきらめきがそっと残る。"],
      windy:["夜の風に合わせ、響きの層がゆるやかに入れ替わる。","静けさを保ったまま、夜の奥行きが深まる。"],
      strong:["夜の空気に風の気配が重なり、余韻が長く残る。","深い夜の景色に、静かな反射がわずかに差す。"]
    };
    return choose(nightByWind[windBand]);
  }

  const lateByWeather={
    clear:["深夜の呼吸に合わせ、輪郭はやわらかくほどける。","深夜の静けさに、透明な余韻だけが残る。"],
    rain:["深夜の雨が空気を丸め、滲む余韻が静かに続く。","深夜の湿った静けさに、響きが淡く溶け込む。"],
    other:["深夜の呼吸に合わせ、輪郭はやわらかくほどける。","深い余白の中で、響きは静かに滞在する。"]
  };
  return choose(lateByWeather[env.weatherCat]||lateByWeather.other);
}
function applyParams(){const env=getEnv();const key=keyFromSeason(env.season);applyWhiteByTime(env.time);let bpm=66;if(env.time==="morning")bpm=74;if(env.time==="day")bpm=78;if(env.time==="evening")bpm=70;if(env.time==="night")bpm=60;if(env.time==="late")bpm=54;Tone.Transport.bpm.value=bpm;const seasonFx=SEASON_SOUND_PROFILE[env.season]||SEASON_SOUND_PROFILE.spring;const timeFx=TIME_SOUND_PROFILE[env.time]||TIME_SOUND_PROFILE.day;const weatherFx=WEATHER_SOUND_PROFILE[env.weatherCat]||WEATHER_SOUND_PROFILE.other;const windNorm=clamp((lastWeather.wind??0)/15,0,1);let cutoff=1950+980*weatherFx.brightness+560*seasonFx.brightness+460*timeFx.brightness;let wet=0.42+weatherFx.wet+0.04*timeFx.space;const uvRaw=(typeof lastWeather.uv==="number")?lastWeather.uv:null;const showUv=(uvRaw!==null)&&isDayTimeBlock(env.time);const uvText=showUv?uvRaw.toFixed(1):"—";if(showUv){const u=clamp(uvRaw/11,0,1);cutoff+=560*u;wet-=0.06*u;}filter.frequency.value=clamp(cutoff,950,3600);masterReverb.wet.value=clamp(wet,0.28,0.70);if(birdFilter){birdFilter.frequency.value=clamp(2050+560*weatherFx.reflect+220*timeFx.brightness,1700,2950);}if(sparkleAutoPanner){let f=0.10;if(env.time==="day")f=0.13;if(env.time==="morning")f=0.12;if(env.time==="evening")f=0.11;if(env.time==="night")f=0.085;if(env.time==="late")f=0.070;sparkleAutoPanner.frequency.value=f;sparkleAutoPanner.depth=clamp(0.70+0.12*weatherFx.reflect+0.11*windNorm,0.62,0.92);}if(airHighpass){airHighpass.frequency.value=clamp(72+52*seasonFx.brightness+42*windNorm,60,155);}if(airChorus){airChorus.depth=clamp(0.10+0.16*seasonFx.shimmer+0.14*windNorm,0.08,0.22);airChorus.wet.value=clamp(0.12+0.08*timeFx.space+0.08*weatherFx.reflect,0.10,0.24);airChorus.frequency.value=clamp(0.15+0.28*windNorm,0.12,0.45);}if(sparkle){sparkle.harmonicity.value=clamp(1.7+0.7*seasonFx.shimmer+0.5*windNorm,1.4,3.1);sparkle.modulationIndex.value=clamp(2.1+1.2*weatherFx.reflect+0.9*windNorm,1.4,4.2);sparkle.volume.value=clamp(-13+2.4*weatherFx.reflect+1.6*timeFx.brightness,-15,-10);}if(crystalLead){crystalLead.harmonicity.value=clamp(2.15+0.5*seasonFx.shimmer+0.3*windNorm,1.8,3.2);crystalLead.modulationIndex.value=clamp(1.5+1.1*weatherFx.reflect+0.45*windNorm,1.1,3.2);crystalLead.volume.value=clamp(-19+2.8*weatherFx.reflect+1.2*timeFx.brightness,-21,-15);}if(stringPad){stringPad.volume.value=clamp(-20+2.1*timeFx.space+1.2*seasonFx.calm,-21,-16);}if(lowLead){lowLead.volume.value=clamp(-20+1.8*seasonFx.calm+1.0*timeFx.space,-21,-16);}if(lowDrone){lowDrone.volume.value=clamp(-22+2.2*seasonFx.calm+1.6*timeFx.space,-24,-17);}if(bellSynth){bellSynth.resonance=clamp(1150+380*weatherFx.reflect+240*windNorm,900,1800);bellSynth.modulationIndex=clamp(18+10*seasonFx.shimmer+8*weatherFx.reflect,12,34);bellSynth.volume.value=clamp(-23+3.0*weatherFx.reflect+1.2*timeFx.brightness,-25,-18);}if(chimeSynth){chimeSynth.harmonicity.value=clamp(2.4+0.9*seasonFx.shimmer+0.6*windNorm,2.0,4.0);chimeSynth.modulationIndex.value=clamp(2.0+1.5*weatherFx.reflect+0.6*windNorm,1.6,4.2);chimeSynth.volume.value=clamp(-24+2.6*weatherFx.reflect+0.8*timeFx.brightness,-25,-19);}if(stringEnsemble){stringEnsemble.volume.value=clamp(-22+2.2*timeFx.space+1.2*seasonFx.calm,-23,-17);}if(harmonySlots){const hAttack=clamp(2.2*seasonFx.padAttack*(1+0.28*timeFx.space),1.9,4.8);const hRelease=clamp(16.5+4.2*timeFx.space+2.0*seasonFx.calm,14.0,23.0);const hHarmonicity=clamp(1.35+0.45*seasonFx.shimmer+0.22*weatherFx.reflect,1.2,2.3);harmonySlots.forEach(slot=>{slot.synth.set({harmonicity:hHarmonicity,modulationIndex:clamp(1.2+0.4*weatherFx.reflect,1.0,2.0),envelope:{attack:hAttack,decay:0.7,sustain:0.8,release:hRelease},modulationEnvelope:{attack:0.4,decay:0.8,sustain:0.3,release:clamp(2.8+timeFx.space*1.6,2.8,4.4)}});});}if(windFilter){windFilter.frequency.value=clamp(340+120*weatherFx.reflect+90*windNorm,280,520);windFilter.Q.value=clamp(0.82+0.26*windNorm+(env.time==="late"?0.14:0),0.78,1.22);}if(waterFilter){waterFilter.frequency.value=clamp(780+210*weatherFx.reflect+80*timeFx.space,680,1080);}const windText=`${(lastWeather.wind??0).toFixed(1)} m/s`;setMediaSessionMetadata(`${env.season} / ${env.weatherCat} / wind ${windText} / UV ${uvText}`);const sub=`Key ${key}`;const mood=moodLine(env,windNorm);setStatusChip(describeWeather(lastWeather.code));playButtonTone(env);if(isRunning)setStatus(sub,mood);const mKey=document.getElementById("metricKey"),mTempo=document.getElementById("metricTempo"),mBright=document.getElementById("metricBrightness"),mSpark=document.getElementById("metricSparkle"),mRev=document.getElementById("metricReverb");if(mKey)mKey.textContent=key;if(mTempo)mTempo.textContent=`${Math.round(bpm)} BPM`;if(mBright)mBright.textContent=(cutoff>2500)?"High":(cutoff>1700?"Mid":"Soft");if(mSpark)mSpark.textContent=(windNorm>0.6||env.weatherCat==="clear")?"Fine+":"Quiet";if(mRev)mRev.textContent=(wet>0.5)?"Deep":(wet>0.38?"Airy":"Dry");const eSeason=document.getElementById("envSeason"),eTime=document.getElementById("envTime"),eWeather=document.getElementById("envWeather"),eWindUv=document.getElementById("envWindUv");if(eSeason)eSeason.textContent=prettyTimeLabel(env.season)||env.season;if(eTime)eTime.textContent=prettyTimeLabel(env.time);if(eWeather)eWeather.textContent=prettyWeatherLabel(env.weatherCat);if(eWindUv)eWindUv.textContent=`${(lastWeather.wind??0).toFixed(1)}m/s · UV ${uvText}`;return {...env,key,bpm,seasonFx,timeFx,weatherFx,windNorm};}
function clearHarmonyScheduler(){if(chordEventId!==null){try{Tone.Transport.clear(chordEventId);}catch(e){} chordEventId=null;}}
function harmonyGapSeconds(r){let g=randomBetween(0.55,2.1);const burstChance=(r.time==="day"||r.time==="morning")?0.30:(r.time==="evening")?0.24:(r.time==="night")?0.16:0.12;if(Math.random()<burstChance){g*=randomBetween(0.20,0.46);}if(r.time==="late")g*=1.12;if(r.time==="night")g*=1.04;if(r.weatherCat==="rain")g*=1.05;return clamp(g,0.22,3.3);} function octaveShifted(note,octShift){const f=Tone.Frequency(note);return f.transpose(12*octShift).toNote();}
function pickOverlapMode(r){let base=0.52;if(r.time==="day"||r.time==="morning")base=0.60;if(r.time==="evening")base=0.54;if(r.time==="night")base=0.44;if(r.time==="late")base=0.32;if(r.weatherCat==="rain")base*=0.92;if(Math.random()>=base)return"none";let earlyWeight=0.78;if(r.time==="late")earlyWeight=0.62;if(r.time==="night")earlyWeight=0.70;if(r.weatherCat==="rain")earlyWeight*=0.95;return(Math.random()<earlyWeight)?"early":"tail";}
function playOneHarmony(startTime,r){if(!harmonySlots)return;const choices=chordChoicesForKey(r.key);let root=choices[Math.floor(Math.random()*choices.length)];if(root===lastRoot)root=choices[Math.floor(Math.random()*choices.length)];lastRoot=root;const playDur=randomBetween(26.0,52.0);const gapDur=harmonyGapSeconds(r);let oct=choose([-1,0,0,0,+1,+1]);if(Math.random()<0.10)oct=choose([-2,+2]);const shiftedRoot=octaveShifted(root,oct);const slot=harmonySlots[harmonySlotIndex%harmonySlots.length];harmonySlotIndex++;const chordGain=slot.gain;const chordPad=slot.synth;let peak=0.15+Math.random()*0.17;if(r.time==="night"||r.time==="late")peak*=0.78;if(r.weatherCat==="rain")peak*=0.86;peak*=(1+(r.timeFx?.density??0)*0.22);peak*=(1+(r.seasonFx?.shimmer??0)*0.12);const t0=startTime,tPeak=startTime+playDur*(0.35+Math.random()*0.35),tEnd=startTime+playDur;chordGain.gain.cancelScheduledValues(t0);chordGain.gain.setValueAtTime(Math.max(0.000001,chordGain.gain.value),t0);chordGain.gain.exponentialRampToValueAtTime(Math.max(0.00018,peak),tPeak);chordGain.gain.exponentialRampToValueAtTime(0.00012,tEnd);markLayerSound("harmony");trackedTriggerAttackRelease(chordPad,triad(shiftedRoot),playDur,startTime,0.72);const mode=pickOverlapMode(r);let nextTime=startTime+playDur+gapDur;if(mode==="tail"){nextTime=tEnd+randomBetween(-10.0,6.0);nextTime=Math.max(nextTime,startTime+7.0);}else if(mode==="early"){const frac=randomBetween(0.30,0.70);nextTime=startTime+playDur*frac;}const nowSec=Tone.Transport.seconds||0;nextTime=Math.max(nextTime,nowSec+2.0);chordEventId=Tone.Transport.scheduleOnce((t)=>{try{playOneHarmony(t,r);}catch(e){console.warn("[harmony] scheduleOnce error",e);}},nextTime);}
function buildMultiTapDelay(){if(sparkleMulti){sparkleMulti.tapNodes.forEach(n=>{try{n.dispose();}catch(e){}});try{sparkleMulti.input.dispose();}catch(e){}try{sparkleMulti.merger.dispose();}catch(e){} sparkleMulti=null;}lastSparkleDelayRebuildAt=0;const taps=randInt(4,7);const merger=new Tone.Gain(1).connect(sparkleAutoPanner);const wetBase=randomBetween(0.40,0.62);const tapNodes=[];for(let i=0;i<taps;i++){const dt=randomBetween(0.03,0.23),fb=randomBetween(0.18,0.44)*(1-i*0.08),wt=clamp(wetBase*(0.85-i*0.06),0.18,0.65);const d=new Tone.FeedbackDelay({delayTime:dt,feedback:fb,wet:wt});d.connect(merger);tapNodes.push(d);}const input=new Tone.Gain(1);tapNodes.forEach(d=>input.connect(d));sparkleMulti={input,tapNodes,merger};return sparkleMulti;}
function pickSparkleDelayRefreshChance(r){if(r.time==="day")return 0.004;if(r.time==="morning")return 0.0035;if(r.time==="evening")return 0.003;if(r.time==="night")return 0.0025;return 0.002;} function rebuildSparkleDelayIfNeeded(r){if(!sparkleMulti){buildMultiTapDelay();sparkle.disconnect();sparkle.connect(sparkleMulti.input);lastSparkleDelayRebuildAt=Date.now();return;}const nowMs=Date.now();const minIntervalMs=180000;if(nowMs-lastSparkleDelayRebuildAt<minIntervalMs)return;if(Math.random()<pickSparkleDelayRefreshChance(r)){buildMultiTapDelay();sparkle.disconnect();sparkle.connect(sparkleMulti.input);lastSparkleDelayRebuildAt=nowMs;}}
function randomRhythmDuration(r){const dayish=(r.time==="morning"||r.time==="day"),nightish=(r.time==="night"||r.time==="late");const short=["32n","16n","16t"],mid=["24n","8t","12n"],long=["8n","4n","6n"];let pool=[...short,...mid];if(dayish)pool=[...short,...short,...mid,"16n"];if(nightish)pool=[...mid,...long,...mid];if(r.weatherCat==="rain")pool=[...pool,...long];const d=choose(pool),sec=Tone.Time(d).toSeconds();return clamp(sec,0.05,0.60);} function applyHitPan(time,r){if(!sparkleHitPanner)return;let width=0.85;if(r.weatherCat==="rain")width=0.70;if(r.time==="night")width=0.62;if(r.time==="late")width=0.52;if(r.time==="day")width=0.92;const target=(Math.random()*2-1)*width;sparkleHitPanner.pan.cancelScheduledValues(time);sparkleHitPanner.pan.setValueAtTime(sparkleHitPanner.pan.value,time);sparkleHitPanner.pan.linearRampToValueAtTime(target,time+0.06);}
function windBaseLevel(r){const mix=getMix();const w=clamp(lastWeather.wind??0,0,15);let base=0.00006+0.00010*(w/15);if(r.time==="night")base*=0.78;if(r.time==="late")base*=0.65;if(r.weatherCat==="rain")base*=0.90;base*=mix.windMul;return clamp(base,0.000001,0.00035);} function waterBaseLevel(r){const mix=getMix();let base=0.00004;if(r.weatherCat==="rain")base=0.00008;if(r.time==="night")base*=0.85;if(r.time==="late")base*=0.70;base*=mix.waterMul;return clamp(base,0.000001,0.00030);} function triggerWindGust(time,r){if(!windGain)return;markLayerSound("wind");const base=windBaseLevel(r),peak=clamp(base*randomBetween(2.0,4.8),0.00001,0.00090),dur=randomBetween(2.4,6.8);windGain.gain.cancelScheduledValues(time);windGain.gain.setValueAtTime(Math.max(0.000001,windGain.gain.value),time);windGain.gain.exponentialRampToValueAtTime(Math.max(0.000001,peak),time+0.7);windGain.gain.exponentialRampToValueAtTime(Math.max(0.000001,base),time+dur);} function triggerWaterRipple(time,r){if(!waterGain)return;markLayerSound("water");const base=waterBaseLevel(r),peak=clamp(base*randomBetween(1.6,3.2),0.00001,0.00085),dur=randomBetween(1.4,4.6);waterGain.gain.cancelScheduledValues(time);waterGain.gain.setValueAtTime(Math.max(0.000001,waterGain.gain.value),time);waterGain.gain.exponentialRampToValueAtTime(Math.max(0.000001,peak),time+0.25);waterGain.gain.exponentialRampToValueAtTime(Math.max(0.000001,base),time+dur);}
function rebuildLoops(){if(isRebuildingLoops)return;isRebuildingLoops=true;try{if(sparkleLoop){try{sparkleLoop.stop(0);}catch(e){}sparkleLoop.dispose();sparkleLoop=null;}if(birdLoop){try{birdLoop.stop(0);}catch(e){}birdLoop.dispose();birdLoop=null;}if(windLoop){try{windLoop.stop(0);}catch(e){}windLoop.dispose();windLoop=null;}if(waterLoop){try{waterLoop.stop(0);}catch(e){}waterLoop.dispose();waterLoop=null;}if(melodyLoop){try{melodyLoop.stop(0);}catch(e){}melodyLoop.dispose();melodyLoop=null;}if(lowMelodyLoop){try{lowMelodyLoop.stop(0);}catch(e){}lowMelodyLoop.dispose();lowMelodyLoop=null;}if(padLoop){try{padLoop.stop(0);}catch(e){}padLoop.dispose();padLoop=null;}if(crystalHarmonyLoop){try{crystalHarmonyLoop.stop(0);}catch(e){}crystalHarmonyLoop.dispose();crystalHarmonyLoop=null;}if(stringHarmonyLoop){try{stringHarmonyLoop.stop(0);}catch(e){}stringHarmonyLoop.dispose();stringHarmonyLoop=null;}if(lowResonanceLoop){try{lowResonanceLoop.stop(0);}catch(e){}lowResonanceLoop.dispose();lowResonanceLoop=null;}if(bellLoop){try{bellLoop.stop(0);}catch(e){}bellLoop.dispose();bellLoop=null;}if(chimeLoop){try{chimeLoop.stop(0);}catch(e){}chimeLoop.dispose();chimeLoop=null;}clearHarmonyScheduler();const r=applyParams();const now=Tone.now();if(windGain)windGain.gain.setValueAtTime(Math.max(0.000001,windBaseLevel(r)),now);if(waterGain)waterGain.gain.setValueAtTime(Math.max(0.000001,waterBaseLevel(r)),now);const startAt=Tone.Transport.seconds+0.1;chordEventId=Tone.Transport.scheduleOnce((t)=>{try{playOneHarmony(t,r);}catch(e){console.warn("[harmony] start schedule error",e);}},startAt);rebuildSparkleDelayIfNeeded(r);const sparkleInterval=0.52;sparkleLoop=new Tone.Loop(safeLoopCallback("sparkle",(time)=>{rebuildSparkleDelayIfNeeded(r);const scale=sparkleScale(r.key,r.weatherCat,r.time);let p=0.60;if(r.weatherCat==="rain")p=0.50;if(r.time==="late")p=0.36;if(r.time==="night")p=Math.min(p,0.44);if(r.weatherCat==="clear"&&(r.time==="day"||r.time==="morning"))p=0.70;p+=(r.seasonFx?.shimmer??0)*0.07;p+=(r.timeFx?.density??0)*0.18;p+=(r.weatherFx?.reflect??0)*0.08;const windBoost=clamp(((lastWeather.wind??0)-2)/10,0,0.14);p+=windBoost;const uvRaw=(typeof lastWeather.uv==="number")?lastWeather.uv:null;if(uvRaw!==null&&(r.time==="day"||r.time==="morning")){const u=clamp(uvRaw/11,0,1);p+=0.12*u;}p=clamp(p,0.14,0.82);if(Math.random()<p){applyHitPan(time,r);const note=scale[Math.floor(Math.random()*scale.length)];const durSec=clamp(randomRhythmDuration(r)*(1+(r.timeFx?.space??0)*0.25),0.05,0.66);const amp=0.36+Math.random()*0.11;if(Math.random()<0.16){const note2=scale[Math.floor(Math.random()*scale.length)],dur2=clamp(durSec*randomBetween(0.75,1.15),0.05,0.55);trackedTriggerAttackReleaseLayer("sparkle",sparkle,note,durSec,time,amp);trackedTriggerAttackReleaseLayer("sparkle",sparkle,note2,dur2,time+0.02,amp*0.82);}else trackedTriggerAttackReleaseLayer("sparkle",sparkle,note,durSec,time,amp);}}),sparkleInterval).start(0);
function birdChance(){const mix=getMix();let base=0.08;if(r.time==="morning")base=0.18;if(r.time==="day")base=0.26;if(r.time==="evening")base=0.14;if(r.time==="night")base=0.04;if(r.time==="late")base=0.018;if(r.weatherCat==="rain")base*=0.70;if(r.weatherCat==="clear"&&(r.time==="day"||r.time==="morning"))base*=1.10;const w=clamp(lastWeather.wind??0,0,15);base*=(1+0.12*(w/15));const uvRaw=(typeof lastWeather.uv==="number")?lastWeather.uv:null;if(uvRaw!==null&&r.time==="day"){const u=clamp(uvRaw/11,0,1);base*=(1+0.12*u);}base*=mix.birdMul;return clamp(base,0.0,0.55);} function chirp(time,amp=0.30){const base=1450+Math.random()*700,up=base+980+Math.random()*560,dur=0.055+Math.random()*0.070;bird.frequency.setValueAtTime(base,time);bird.frequency.linearRampToValueAtTime(up,time+dur);bird.frequency.linearRampToValueAtTime(base+240,time+dur+0.03);trackedTriggerAttackReleaseLayer("bird",bird,"C6",dur+0.06,time,amp);} function phrase(time){const n=(Math.random()<0.50)?2:(Math.random()<0.80?3:5);const baseGap=0.10+Math.random()*0.09;for(let i=0;i<n;i++){const t=time+i*(baseGap+Math.random()*0.06);chirp(t,0.26+Math.random()*0.12);}} function birdLoopIntervalSeconds(){if(r.time==="day")return 1.55;if(r.time==="morning")return 1.70;if(r.time==="evening")return 2.05;if(r.time==="night")return 2.80;return 3.40;}
birdLoop=new Tone.Loop(safeLoopCallback("bird",(time)=>{if(!bird)return;const p=birdChance();if(Math.random()<p){if(r.time==="night"||r.time==="late"){chirp(time,0.23);if(Math.random()<0.22)chirp(time+0.16+Math.random()*0.10,0.21);return;}const roll=Math.random();if(roll<0.46){chirp(time,0.28+Math.random()*0.10);if(Math.random()<(r.time==="day"?0.62:0.46))chirp(time+0.12+Math.random()*0.12,0.24+Math.random()*0.10);}else if(roll<0.80){const n=(Math.random()<0.55)?2:4;for(let i=0;i<n;i++)chirp(time+i*(0.11+Math.random()*0.10),0.23+Math.random()*0.12);}else phrase(time);}}),birdLoopIntervalSeconds()).start(0);
function windLoopInterval(){if(r.time==="day")return 3.2;if(r.time==="morning")return 3.6;if(r.time==="evening")return 4.0;if(r.time==="night")return 5.0;return 6.2;} windLoop=new Tone.Loop(safeLoopCallback("wind",(time)=>{const mix=getMix();const w=clamp(lastWeather.wind??0,0,15);let p=0.20+0.35*(w/15);if(r.time==="late")p*=0.70;if(r.weatherCat==="rain")p*=0.90;p*=clamp(0.15+0.85*mix.windMul,0.0,2.0);p=clamp(p,0.0,0.78);if(Math.random()<p)triggerWindGust(time,r);}),windLoopInterval()).start(0);
function waterLoopInterval(){if(r.weatherCat==="rain")return 3.0;if(r.time==="day")return 4.2;if(r.time==="morning")return 4.6;if(r.time==="evening")return 5.0;if(r.time==="night")return 6.2;return 7.2;} waterLoop=new Tone.Loop(safeLoopCallback("water",(time)=>{const mix=getMix();let p=(r.weatherCat==="rain")?0.44:0.26;if(r.time==="late")p*=0.75;if(r.time==="night")p*=0.85;p*=clamp(0.15+0.85*mix.waterMul,0.0,2.0);p=clamp(p,0.0,0.66);if(Math.random()<p)triggerWaterRipple(time,r);}),waterLoopInterval()).start(0);
padLoop=new Tone.Loop(safeLoopCallback("pad",(time)=>{if(!stringPad||!padGain)return;const roots=chordChoicesForKey(r.key);const root=choose(roots);const dur=randomBetween(18,34);const notes=triad(octaveShifted(root,-1));const base=0.00010+(r.time==="night"||r.time==="late"?0.00002:0.00005);padGain.gain.cancelScheduledValues(time);padGain.gain.setValueAtTime(Math.max(0.000001,padGain.gain.value),time);padGain.gain.exponentialRampToValueAtTime(base,time+4.0);padGain.gain.exponentialRampToValueAtTime(0.00002,time+dur);trackedTriggerAttackReleaseLayer("pad",stringPad,notes,dur,time,0.28);}),randomBetween(12,18)).start(0);
melodyLoop=new Tone.Loop(safeLoopCallback("melody",(time)=>{if(!crystalLead)return;const mScale=melodyScaleForKey(r.key);const melodyOnlyChance=(r.time==="night"||r.time==="late")?0.42:0.22;const useMelodyOnly=Math.random()<melodyOnlyChance;const phraseLen=useMelodyOnly?(Math.random()<0.6?3:4):(Math.random()<0.5?2:3);for(let i=0;i<phraseLen;i++){const n=choose(mScale);const t=time+i*randomBetween(0.45,0.95);const d=melodyDuration(r)*(useMelodyOnly?1.18:0.82);const v=useMelodyOnly?0.36:0.28;trackedTriggerAttackReleaseLayer("melody",crystalLead,n,d,t,v);}if(useMelodyOnly&&sparkle&&Math.random()<0.7){sparkle.volume.value=-24;}else if(sparkle){sparkle.volume.value=-12;}}),randomBetween(3.4,6.2)).start(0);lowMelodyLoop=new Tone.Loop(safeLoopCallback("lowMelody",(time)=>{if(!lowLead)return;const lowScale=lowMelodyScaleForKey(r.key);const n=choose(lowScale);const d=clamp(melodyDuration(r)*1.22,2.2,7.2);trackedTriggerAttackReleaseLayer("melody",lowLead,n,d,time,0.34);if(Math.random()<0.35){const n2=choose(lowScale);trackedTriggerAttackReleaseLayer("melody",lowLead,n2,d*0.78,time+randomBetween(0.7,1.4),0.26);}}),randomBetween(5.2,8.4)).start(0);crystalHarmonyLoop=new Tone.Loop(safeLoopCallback("crystalHarmony",(time)=>{if(!crystalLead)return;const root=choose(chordChoicesForKey(r.key));const chord=triad(octaveShifted(root,1));const pick=[chord[0],chord[1],chord[2]];trackedTriggerAttackReleaseLayer("melody",crystalLead,choose(pick),randomBetween(2.4,4.8),time,0.24);if(Math.random()<0.66){trackedTriggerAttackReleaseLayer("melody",crystalLead,choose(pick),randomBetween(2.0,4.2),time+randomBetween(0.25,0.7),0.20);}}),randomBetween(4.8,8.0)).start(0);stringHarmonyLoop=new Tone.Loop(safeLoopCallback("stringHarmony",(time)=>{if(!stringPad)return;const root=choose(chordChoicesForKey(r.key));const chord=triad(octaveShifted(root,0));const seasonalChance=(r.season==="winter"||r.season==="autumn")?0.82:0.64;if(Math.random()<seasonalChance){trackedTriggerAttackRelease(stringPad,[chord[1],chord[2]],randomBetween(4.8,8.4),time,0.22);}if(Math.random()<0.42){trackedTriggerAttackRelease(stringPad,[chord[0]],randomBetween(3.8,6.5),time+randomBetween(0.3,0.9),0.18);}}),randomBetween(6.2,10.0)).start(0);lowResonanceLoop=new Tone.Loop(safeLoopCallback("lowResonance",(time)=>{if(!lowDrone)return;const lowScale=lowMelodyScaleForKey(r.key);const note=choose(lowScale.slice(0,4));const dur=randomBetween(7.0,13.5);const amp=(r.time==="night"||r.time==="late")?0.33:0.27;trackedTriggerAttackReleaseLayer("melody",lowDrone,note,dur,time,amp);if(Math.random()<0.34){trackedTriggerAttackReleaseLayer("melody",lowDrone,note,dur*0.62,time+randomBetween(1.1,2.2),amp*0.78);}}),randomBetween(9.0,14.0)).start(0);bellLoop=new Tone.Loop(safeLoopCallback("bell",(time)=>{if(!bellSynth)return;const brightChance=clamp(0.08+0.20*(r.weatherFx?.reflect??0)+0.16*(r.seasonFx?.shimmer??0)+0.10*(r.windNorm??0),0.03,0.34);if(Math.random()<brightChance){bellSynth.frequency=choose([320,360,420,480,540,620]);markSoundActivity();bellSynth.triggerAttack(time,0.22);}if(Math.random()<brightChance*0.45){bellSynth.frequency=choose([520,620,760]);markSoundActivity();bellSynth.triggerAttack(time+randomBetween(0.08,0.3),0.15);}}),randomBetween(2.8,5.6)).start(0);chimeLoop=new Tone.Loop(safeLoopCallback("chime",(time)=>{if(!chimeSynth)return;const scale=melodyScaleForKey(r.key);const p=(r.weatherCat==="clear"?0.30:(r.weatherCat==="rain"?0.14:0.22))*(r.time==="late"?0.65:1.0);if(Math.random()<p){const n=choose(scale);trackedTriggerAttackReleaseLayer("melody",chimeSynth,n,randomBetween(1.2,2.8),time,0.22);}if(Math.random()<p*0.42){trackedTriggerAttackReleaseLayer("melody",chimeSynth,choose(scale),randomBetween(0.9,2.2),time+randomBetween(0.15,0.5),0.18);}}),randomBetween(3.0,6.8)).start(0);
}finally{isRebuildingLoops=false;} // STABILITY FIX: always release rebuild guard
}
function playButtonTone(env){const btn=document.getElementById("btnToggle"),label=document.getElementById("btnLabel"),sub=document.getElementById("btnSub");if(!btn||!label||!sub)return;const uvRaw=(typeof lastWeather.uv==="number")?lastWeather.uv:0;const u=clamp(uvRaw/11,0,1);if(!isRunning){btn.className="mt-7 w-full rounded-[30px] px-6 py-8 transition active:scale-[0.99] bg-slate-900 text-white hover:bg-slate-800 shadow-[0_18px_40px_rgba(15,23,42,0.18)] relative overflow-hidden";label.className="text-2xl font-semibold text-white";sub.className="text-xs text-white/80";btn.style.opacity="1";btn.style.boxShadow="0 18px 40px rgba(15,23,42,0.18), inset 0 0 0 0 rgba(255,255,255,0)";return;}const byTime={morning:"from-sky-50 to-cyan-100",day:"from-sky-100 to-blue-100",evening:"from-rose-100 to-stone-200",night:"from-slate-800 to-indigo-900",late:"from-slate-900 to-indigo-900"};let grad=byTime[env.time]||byTime.day;const darkBg=(env.time==="night"||env.time==="late");if(env.weatherCat==="rain")grad=darkBg?"from-slate-800 to-slate-700":"from-slate-100 to-slate-200";const txt=darkBg?"text-white":"text-slate-900";btn.className=`mt-7 w-full rounded-[30px] px-6 py-8 transition active:scale-[0.99] bg-gradient-to-br ${grad} ${txt} shadow-[0_14px_32px_rgba(15,23,42,0.10)] border border-slate-200 relative overflow-hidden`;label.className=`text-2xl font-semibold ${darkBg?"text-white":"text-slate-900"}`;sub.className=`text-xs ${darkBg?"text-white/80":"text-slate-700"}`;const alpha=(env.weatherCat==="rain")?(0.95+0.02*u):(0.96+0.03*u);btn.style.opacity=String(alpha);btn.style.boxShadow=darkBg?"0 14px 32px rgba(15,23,42,0.14), inset 0 1px 0 rgba(255,255,255,0.08)":"0 14px 32px rgba(15,23,42,0.10), inset 0 0 0 1px rgba(255,255,255,0.35)";}
// STABILITY FIX: per-layer silence recovery without changing musical parameters
async function recoverLayerLoopIfSilent(layer){
  const now=Date.now();
  const lastAt=layerLastSoundAt[layer]||0;
  const lastRecovery=layerLastRecoveryAt[layer]||0;
  const threshold=LAYER_SILENCE_MS[layer]||60000;
  if(!isRunning)return false;
  if(now-lastAt<=threshold)return false;
  if(now-lastRecovery<=LAYER_RECOVERY_COOLDOWN_MS)return false;
  if(now-lastAnyLayerRecoveryAt<=GLOBAL_LAYER_RECOVERY_COOLDOWN_MS)return false;
  layerLastRecoveryAt[layer]=now;
  lastAnyLayerRecoveryAt=now;

  await resumeAudioIfNeeded(`layer-${layer}`);

  if(layer==="harmony"){
    try{
      clearHarmonyScheduler();
      const startAt=Tone.Transport.seconds+0.12;
      chordEventId=Tone.Transport.scheduleOnce((t)=>{try{playOneHarmony(t,applyParams());}catch(e){console.warn("[harmony] reschedule failed",e);}},startAt);
      markLayerSound("harmony");
      return true;
    }catch(e){
      console.warn("[harmony] recovery failed",e);
      return false;
    }
  }

  if((Date.now()-lastSoundAt)>60000&&!isRebuildingLoops){
    try{
      rebuildLoops();
      markLayerSound(layer);
      return true;
    }catch(e){
      console.warn(`[${layer}] rebuild recovery failed`,e);
    }
  }

  return false;
}

function ensureHarmonySchedulerAlive(){
  if(!isRunning||isRebuildingLoops)return;
  if(chordEventId!==null)return;
  const nowSec=Tone.Transport.seconds||0;
  try{
    const r=applyParams();
    chordEventId=Tone.Transport.scheduleOnce((t)=>{try{playOneHarmony(t,r);}catch(e){console.warn("[harmony] watchdog schedule error",e);}},nowSec+0.2);
  }catch(e){console.warn("[harmony] watchdog ensure failed",e);}
}

// [STABILITY FIX] watchdog: context + transport + silence detection with bounded recovery
function startPlaybackWatchdog(){
  if(playbackWatchdogId)return;
  lastTransportSeconds=Tone.Transport.seconds||0;
  lastTransportCheckAt=Date.now();
  lastSoundAt=Date.now();
  silentRecoveryCount=0;
  playbackWatchdogId=setInterval(async()=>{
    if(isRecovering)return;
    isRecovering=true;
    try{
    if(!isRunning)return;
    const nowMs=Date.now();
    const nowSec=Tone.Transport.seconds||0;
    const stalled=(Math.abs(nowSec-lastTransportSeconds)<0.0001)&&(nowMs-lastTransportCheckAt>15000);
    const silent=(nowMs-lastSoundAt)>120000;
    lastTransportSeconds=nowSec;
    lastTransportCheckAt=nowMs;

    if(stalled||silent){
      await resumeAudioIfNeeded(stalled?"transport-stall":"silence");
    }

    ensureHarmonySchedulerAlive();

    // STABILITY FIX: detect per-layer silence while transport still runs
    if(!stalled){
      const recoveredSparkle=await recoverLayerLoopIfSilent("sparkle");
      const recoveredBird=await recoverLayerLoopIfSilent("bird");
      const recoveredWind=await recoverLayerLoopIfSilent("wind");
      const recoveredWater=await recoverLayerLoopIfSilent("water");
      const recoveredMelody=await recoverLayerLoopIfSilent("melody");
      const recoveredPad=await recoverLayerLoopIfSilent("pad");
      const recoveredHarmony=await recoverLayerLoopIfSilent("harmony");
      if(recoveredSparkle||recoveredBird||recoveredWind||recoveredWater||recoveredMelody||recoveredPad||recoveredHarmony){
        await resumeAudioIfNeeded("layer-recovered");
      }
    }

    if(silent){
      if(nowMs-lastRebuildAttemptAt>REBUILD_COOLDOWN_MS&&!isRebuildingLoops){
        lastRebuildAttemptAt=nowMs;
        try{rebuildLoops();silentRecoveryCount=Math.min(silentRecoveryCount+1,4);}catch(e){}
      }

      if((nowMs-lastSoundAt)>300000&&silentRecoveryCount>=1&&nowMs-lastHardRecoveryAt>HARD_RECOVERY_COOLDOWN_MS){
        lastHardRecoveryAt=nowMs;
        try{Tone.Transport.stop();}catch(e){}
        try{Tone.Transport.start();}catch(e){}
        if(!isRebuildingLoops){
          try{rebuildLoops();silentRecoveryCount=Math.min(silentRecoveryCount+1,4);}catch(e){}
        }
      }

      if((nowMs-lastSoundAt)>480000&&nowMs-lastHardRecoveryAt>HARD_RECOVERY_COOLDOWN_MS){
        // [STABILITY FIX] final fallback: hard reset context graph only when recovery repeatedly fails
        lastHardRecoveryAt=nowMs;
        try{Tone.Transport.stop();}catch(e){}
        try{Tone.Transport.cancel(0);}catch(e){}
        try{disposeAudioGraphForRecovery();}catch(e){console.warn("[watchdog] graph dispose failed",e);}
        try{const ctx=Tone.getContext?.().rawContext||Tone.context?.rawContext||Tone.context;if(ctx&&ctx.state!=="closed")await ctx.close();}catch(e){console.warn("[watchdog] context close failed",e);}
        try{await Tone.start();}catch(e){console.warn("[watchdog] context restart failed",e);}
        try{bindAudioContextStateWatcher();}catch(e){}
        try{bindUserGestureResume();}catch(e){}
        try{configureToneRuntime();}catch(e){}
        try{await ensureAudioGraph();}catch(e){console.warn("[watchdog] graph rebuild failed",e);}
        if(isRunning&&!isRebuildingLoops){
          try{Tone.Transport.start();}catch(e){console.warn("[watchdog] transport restart failed",e);}
          try{await resumeAudioIfNeeded("hard-recovery",true);}catch(e){}
          try{rebuildLoops();}catch(e){console.warn("[watchdog] loop rebuild failed",e);}
          try{applyParams();}catch(e){console.warn("[watchdog] params apply failed",e);}
        }
      }
    }else{
      silentRecoveryCount=0;
    }
    }finally{
      isRecovering=false;
    }
  },10000);
}
function stopPlaybackWatchdog(){if(!playbackWatchdogId)return;clearInterval(playbackWatchdogId);playbackWatchdogId=null;silentRecoveryCount=0;}
function setButtonState(){const label=document.getElementById("btnLabel"),sub=document.getElementById("btnSub"),iconSvg=document.getElementById("iconSvg");if(isRunning){label.textContent="Stop";sub.textContent="タップで停止";sub.className="text-xs text-sky-100";iconSvg.innerHTML='<path d="M6 6h5v12H6zM13 6h5v12h-5z"></path>';}else{label.textContent="Start";sub.textContent="タップで再生";sub.className="text-xs text-white/80";iconSvg.innerHTML='<path d="M8 5v14l11-7z"></path>';setStatusChip("—");setStatus("待機中","夜の澄んだ空気、きらめき控えめ。");}playButtonTone(getEnv());updatePlaybackState();}
async function start(){configureToneRuntime();await ensureAudioGraph();Tone.Destination.mute=false;await Tone.start();bindAudioContextStateWatcher();bindUserGestureResume();await resumeAudioIfNeeded("start",true);await requestWakeLock();Tone.Transport.start();rebuildLoops();isRunning=true;lastSoundAt=Date.now();Object.keys(layerLastSoundAt).forEach(k=>layerLastSoundAt[k]=Date.now());startPlaybackWatchdog();setButtonState();applyParams();}
function stop(){isRunning=false;stopPlaybackWatchdog();Tone.Destination.mute=true;audioRecoveryInFlight=false;isRecovering=false;clearHarmonyScheduler();if(sparkleLoop){sparkleLoop.stop();sparkleLoop.dispose();sparkleLoop=null;}if(birdLoop){birdLoop.stop();birdLoop.dispose();birdLoop=null;}if(windLoop){windLoop.stop();windLoop.dispose();windLoop=null;}if(waterLoop){waterLoop.stop();waterLoop.dispose();waterLoop=null;}if(melodyLoop){melodyLoop.stop();melodyLoop.dispose();melodyLoop=null;}if(lowMelodyLoop){lowMelodyLoop.stop();lowMelodyLoop.dispose();lowMelodyLoop=null;}if(padLoop){padLoop.stop();padLoop.dispose();padLoop=null;}if(crystalHarmonyLoop){crystalHarmonyLoop.stop();crystalHarmonyLoop.dispose();crystalHarmonyLoop=null;}if(stringHarmonyLoop){stringHarmonyLoop.stop();stringHarmonyLoop.dispose();stringHarmonyLoop=null;}if(lowResonanceLoop){lowResonanceLoop.stop();lowResonanceLoop.dispose();lowResonanceLoop=null;}if(bellLoop){bellLoop.stop();bellLoop.dispose();bellLoop=null;}if(chimeLoop){chimeLoop.stop();chimeLoop.dispose();chimeLoop=null;}Tone.Transport.stop();Tone.Transport.cancel(0);if(sparkleMulti){sparkleMulti.tapNodes.forEach(n=>{try{n.dispose();}catch(e){}});try{sparkleMulti.input.dispose();}catch(e){}try{sparkleMulti.merger.dispose();}catch(e){} sparkleMulti=null;}lastSparkleDelayRebuildAt=0;const now=Tone.now();try{if(windGain)windGain.gain.setValueAtTime(0.000001,now);if(waterGain)waterGain.gain.setValueAtTime(0.000001,now);if(harmonySlots){harmonySlots.forEach(s=>{try{s.gain.gain.cancelScheduledValues(now);}catch(e){}try{s.gain.gain.setValueAtTime(0.000001,now);}catch(e){}});}if(padGain){padGain.gain.setValueAtTime(0.000001,now);}if(sparkle){sparkle.volume.value=-12;}}catch(e){} setStatusChip(describeWeather(lastWeather.code));setStatus("待機中","再生ボタンで開始");setButtonState();releaseWakeLock();}
async function refreshWeather(){if(isRefreshingWeather)return;isRefreshingWeather=true;try{nextUpdateAt=Date.now()+AUTO_UPDATE_MS;setStatusChip("—");setStatus("取得中…","天気/風/UV");const pos=await getCurrentPosition();const lat=pos.coords.latitude,lon=pos.coords.longitude;const {code,wind,uv}=await fetchWeatherByCoords(lat,lon);lastWeather={code,wind,uv};applyParams();if(isRunning){applyParams();}else{const env=getEnv();const key=keyFromSeason(env.season);const uvRaw=(typeof lastWeather.uv==="number")?lastWeather.uv:null;const showUv=(uvRaw!==null)&&isDayTimeBlock(env.time);const uvText=showUv?uvRaw.toFixed(1):"—";const mood=moodLine(env,clamp((lastWeather.wind??0)/15,0,1));setStatusChip(describeWeather(lastWeather.code));setStatus(`Key ${key}`,mood);}}catch(e){console.error(e);nextUpdateAt=Date.now()+WEATHER_RETRY_MS;setStatusChip("—");setStatus("エラー",`${e.message}（${Math.floor(WEATHER_RETRY_MS/1000)}秒後に再試行）`);}finally{isRefreshingWeather=false;}}
function tick(){const remain=Math.max(0,nextUpdateAt-Date.now());const mm=String(Math.floor(remain/60000)).padStart(2,"0"),ss=String(Math.floor((remain%60000)/1000)).padStart(2,"0");document.getElementById("countdown").textContent=`${mm}:${ss}`;if(remain<=0&&!isRefreshingWeather)refreshWeather();requestAnimationFrame(tick);} 
const settingsDetails=document.getElementById("settingsDetails"),settingsOverlay=document.getElementById("settingsOverlay"),settingsBackdrop=document.getElementById("settingsBackdrop"),btnCloseSettings=document.getElementById("btnCloseSettings");
const tabButtons=Array.from(document.querySelectorAll(".tabBtn")),tabSettings=document.getElementById("tabSettings"),tabGuide=document.getElementById("tabGuide");let settingsCloseTimer=null;const guideTransitionLayer=document.getElementById("guideTransitionLayer"); function resetGuideToStart(){const scroller=document.getElementById("guidePages");if(scroller)scroller.scrollTo({top:0,behavior:"auto"});const dots=Array.from(document.querySelectorAll("#guideIndicator .guide-dot"));if(dots.length)dots.forEach((d,i)=>d.classList.toggle("is-active",i===0));const pages=Array.from(document.querySelectorAll("#guidePages .guide-page"));if(pages.length)pages.forEach((pg,i)=>pg.classList.toggle("is-current",i===0));} /* DESIGN UPDATE */ function setTab(id){const isSettings=(id==="tabSettings");tabSettings.classList.toggle("hidden",!isSettings);tabGuide.classList.toggle("hidden",isSettings);if(id==="tabGuide")resetGuideToStart();tabButtons.forEach(btn=>{const active=btn.dataset.tab===id;btn.className="tabBtn flex-1 px-3 py-2 rounded-2xl text-sm border "+(active?"border-slate-200 bg-sky-50/60 text-slate-700":"border-slate-200 bg-white text-slate-600 hover:bg-slate-50");});}
function openSettings(){if(settingsCloseTimer){clearTimeout(settingsCloseTimer);settingsCloseTimer=null;}if(guideTransitionLayer)guideTransitionLayer.classList.remove("is-active");settingsOverlay.classList.remove("hidden");requestAnimationFrame(()=>settingsOverlay.classList.add("is-open"));settingsDetails.open=false;document.documentElement.classList.add("overflow-hidden");document.body.classList.add("overflow-hidden");setTab("tabSettings");} function closeSettings(afterClose,durationMs=560){settingsOverlay.classList.remove("is-open");const finalize=()=>{settingsOverlay.classList.add("hidden");document.documentElement.classList.remove("overflow-hidden");document.body.classList.remove("overflow-hidden");if(typeof afterClose==="function")afterClose();};settingsCloseTimer=setTimeout(finalize,durationMs);} /* DESIGN UPDATE */
settingsDetails.addEventListener("toggle",()=>{if(settingsDetails.open)openSettings();}); btnCloseSettings.addEventListener("click",closeSettings); settingsBackdrop.addEventListener("click",closeSettings); document.addEventListener("keydown",(e)=>{if(e.key==="Escape")closeSettings();}); tabButtons.forEach(btn=>btn.addEventListener("click",()=>setTab(btn.dataset.tab)));
document.getElementById("btnToggle").addEventListener("click",async()=>{if(!isRunning)await start();else stop();}); document.getElementById("btnRefresh").addEventListener("click",()=>refreshWeather()); ["seasonSel","timeSel","weatherSel"].forEach(id=>{document.getElementById(id).addEventListener("change",()=>{applyParams();if(isRunning&&!isRebuildingLoops)rebuildLoops();applyParams();});});
function bindMixSliders(){const b=document.getElementById("birdMix"),w=document.getElementById("windMix"),wa=document.getElementById("waterMix");if(!b||!w||!wa)return;b.addEventListener("input",()=>{mixState.bird=clamp(parseInt(b.value,10)||0,0,100);onMixChange();});w.addEventListener("input",()=>{mixState.wind=clamp(parseInt(w.value,10)||0,0,100);onMixChange();});wa.addEventListener("input",()=>{mixState.water=clamp(parseInt(wa.value,10)||0,0,100);onMixChange();});}function bindUiNuance(){const ids=["nuanceSparkle","nuanceSpeed","nuanceBright","nuanceReverb"];ids.forEach(id=>{const el=document.getElementById(id);const chip=document.getElementById(id.replace("nuance","nuance")+"Mode");if(!el||!chip)return;el.addEventListener("input",()=>{const v=parseInt(el.value,10)||0;chip.textContent=(v===50)?"Auto":"Manual";chip.className="text-[10px] px-2 py-0.5 rounded-full border "+((v===50)?"border-slate-200 text-slate-500":"border-slate-900 text-slate-800 bg-slate-50");});});const btn=document.getElementById("btnAllAuto");if(btn){btn.addEventListener("click",()=>{["seasonSel","timeSel","weatherSel"].forEach(id=>{const el=document.getElementById(id);if(el)el.value="auto";});ids.forEach(id=>{const el=document.getElementById(id);if(el)el.value="50";const chip=document.getElementById(id+"Mode");if(chip){chip.textContent="Auto";chip.className="text-[10px] px-2 py-0.5 rounded-full border border-slate-200";}});mixState.bird=50;mixState.wind=50;mixState.water=50;syncMixUI();saveMix();applyParams();if(isRunning)rebuildLoops();});}}
function initGuideReveal(){const scroller=document.getElementById("guidePages");const dots=Array.from(document.querySelectorAll("#guideIndicator .guide-dot"));if(!scroller||!dots.length)return;const pages=Array.from(scroller.querySelectorAll(".guide-page"));let returningTop=false;let activeIndex=0;let touchStartY=null;let lastSlideEnteredAt=0;let lastUserNextAttemptAt=0;const reduced=window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches;const isGuideOpen=()=>!tabGuide.classList.contains("hidden")&&!settingsOverlay.classList.contains("hidden");const isAtGuideEnd=()=>Math.abs((scroller.scrollTop+scroller.clientHeight)-scroller.scrollHeight)<2;const goTopFromGuide=()=>{if(returningTop||!isGuideOpen())return;returningTop=true;scroller.scrollTo({top:0,behavior:"auto"});const finalize=()=>{if(guideTransitionLayer)guideTransitionLayer.classList.remove("is-active");settingsOverlay.classList.remove("guide-overlay-fade");setTab("tabSettings");window.scrollTo({top:0,behavior:"smooth"});returningTop=false;};if(reduced){closeSettings(finalize,560);return;}settingsOverlay.classList.add("guide-overlay-fade");if(guideTransitionLayer){guideTransitionLayer.classList.add("is-active");setTimeout(()=>closeSettings(finalize,2200),20);}else{closeSettings(finalize,2200);}};const handleGuideNext=(action,source="user")=>{if(source!=="user")return;if(returningTop||!isGuideOpen())return;if(activeIndex===pages.length-1&&action==="next"){if(!isAtGuideEnd())return;const now=Date.now();if(now-lastSlideEnteredAt<550)return; // DESIGN UPDATE: avoid momentum-triggered pseudo-auto return
if(now-lastUserNextAttemptAt<220)return; // DESIGN UPDATE: debounce burst events
lastUserNextAttemptAt=now;goTopFromGuide();return;}const nextIdx=Math.min(activeIndex+1,pages.length-1);pages[nextIdx].scrollIntoView({behavior:reduced?"auto":"smooth",block:"start"});};const setActive=(idx)=>{activeIndex=idx;if(idx===pages.length-1)lastSlideEnteredAt=Date.now();dots.forEach((d,i)=>d.classList.toggle("is-active",i===idx));pages.forEach((p,i)=>p.classList.toggle("is-current",i===idx));};scroller.addEventListener("wheel",(e)=>{if(e.deltaY>0&&activeIndex===pages.length-1)handleGuideNext("next","user");},{passive:true});scroller.addEventListener("touchstart",(e)=>{touchStartY=e.touches&&e.touches[0]?e.touches[0].clientY:null;},{passive:true});scroller.addEventListener("touchend",(e)=>{const endY=e.changedTouches&&e.changedTouches[0]?e.changedTouches[0].clientY:null;if(touchStartY!==null&&endY!==null&&(touchStartY-endY)>18&&activeIndex===pages.length-1)handleGuideNext("next","user");touchStartY=null;},{passive:true});document.addEventListener("keydown",(e)=>{if(!isGuideOpen())return;if(["ArrowDown","PageDown","Space"].includes(e.code)||["ArrowDown","PageDown"," "].includes(e.key)){e.preventDefault();handleGuideNext("next","user");}});const hasIO=("IntersectionObserver" in window);if(!hasIO){setActive(0);return;}const io=new IntersectionObserver((entries)=>{entries.forEach(entry=>{if(entry.isIntersecting){const idx=pages.indexOf(entry.target);if(idx>=0)setActive(idx);}});},{root:scroller,threshold:0.65});pages.forEach(p=>io.observe(p));if(reduced){setActive(0);} } // DESIGN UPDATE
  loadMix();syncMixUI();setButtonState();applyWhiteByTime(autoTimeBlock());refreshWeather();tick();bindMixSliders();bindUiNuance();initGuideReveal();
</script>
</body>
</html>
