<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ambient Music</title>

  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.3.5/Tone.js"></script>

  <style>
    summary::-webkit-details-marker { display:none; }
    .ios-scroll { -webkit-overflow-scrolling: touch; }
    .glass {
      background: rgba(255,255,255,.72);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    input[type="range"]{ accent-color:#0f172a; }
  </style>
</head>

<body class="min-h-screen text-slate-900">
  <main class="min-h-screen flex items-center justify-center p-5 sm:p-8">
    <div class="w-full max-w-xl">
      <div class="rounded-[28px] border border-white/70 glass shadow-[0_20px_60px_rgba(15,23,42,0.10)] overflow-hidden">
        <div class="px-6 sm:px-8 pt-7 pb-5">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="inline-flex items-center gap-2 rounded-full bg-white/80 border border-slate-200 px-3 py-1 text-xs text-slate-600">
                <span id="dot" class="inline-block size-2 rounded-full bg-slate-400"></span>
                <span id="modeText">Ready</span>
              </div>

              <h1 class="mt-3 text-2xl font-semibold tracking-tight">Ambient Music</h1>

              <p class="mt-1 text-sm text-slate-600">季節、天気、風のゆらぎ。</p>
              <p class="mt-1 text-sm text-slate-600">いまこの瞬間の自然と同期し、音楽を紡ぐ。</p>
            </div>

            <div class="text-right">
              <div class="text-[10px] sm:text-xs text-slate-500 whitespace-nowrap">自動更新</div>
              <div id="countdown" class="mt-1 text-sm font-medium text-slate-700 tabular-nums">—</div>
            </div>
          </div>

          <button id="btnToggle"
            class="mt-5 w-full rounded-3xl px-5 py-6 sm:py-7 transition active:scale-[0.99]
                   bg-slate-900 text-white hover:bg-slate-800
                   shadow-[0_18px_40px_rgba(15,23,42,0.22)]">
            <div class="flex items-center justify-center gap-4">
              <div class="grid place-items-center size-12 rounded-2xl bg-white/10 border border-white/15">
                <svg id="iconSvg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" class="opacity-95">
                  <path d="M8 5v14l11-7z"></path>
                </svg>
              </div>
              <div class="text-left">
                <div id="btnLabel" class="text-xl font-semibold">Start</div>
                <div id="btnSub" class="text-xs text-white/75">タップで再生</div>
              </div>
            </div>
          </button>

          <div class="mt-4">
            <div class="rounded-2xl bg-white/75 border border-slate-200 px-4 py-3">
              <div class="flex items-center justify-between">
                <div class="text-xs text-slate-500">状態</div>
                <div id="statusChip" class="text-[11px] text-slate-500 tabular-nums">—</div>
              </div>
              <div id="statusMain" class="mt-1 text-base font-medium text-slate-800">待機中</div>
              <div id="statusSub" class="mt-0.5 text-[12px] text-slate-600">—</div>
            </div>
          </div>
        </div>

        <div class="border-t border-white/70 bg-white/55">
          <div class="px-6 sm:px-8 py-4 flex items-center justify-between gap-3">
            <button id="btnRefresh"
              class="px-4 py-2 rounded-2xl text-sm bg-white/80 border border-slate-200 hover:bg-white active:scale-[0.99]">
              更新
            </button>

            <details id="settingsDetails" class="group">
              <summary
                class="list-none cursor-pointer select-none px-4 py-2 rounded-2xl text-sm
                       bg-white/80 border border-slate-200 hover:bg-white active:scale-[0.99]
                       inline-flex items-center gap-2">
                設定
                <span class="text-slate-400 group-open:rotate-180 transition">▾</span>
              </summary>
            </details>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="settingsOverlay" class="fixed inset-0 z-50 hidden"><div id="settingsBackdrop" class="absolute inset-0 bg-slate-900/10 backdrop-blur-[2px]"></div>
    <div class="absolute inset-0 flex items-end sm:items-center justify-center p-3 sm:p-6"><div class="w-full max-w-[560px] rounded-[28px] bg-white/95 border border-slate-200 shadow-2xl overflow-hidden"><div class="px-5 sm:px-6 pt-4 pb-3 border-b border-slate-200"><div class="flex items-center justify-between gap-3"><div class="text-sm font-semibold text-slate-800">設定</div><button id="btnCloseSettings" class="px-3 py-1.5 rounded-xl text-sm bg-slate-900 text-white hover:bg-slate-800 active:scale-[0.99]">閉じる</button></div><div class="mt-3 flex gap-2"><button data-tab="tabSettings" class="tabBtn flex-1 px-3 py-2 rounded-2xl text-sm border border-slate-200 bg-slate-900 text-white">設定</button><button data-tab="tabGuide" class="tabBtn flex-1 px-3 py-2 rounded-2xl text-sm border border-slate-200 bg-white text-slate-700 hover:bg-slate-50">仕組み</button></div></div>
        <div class="px-5 sm:px-6 py-4 max-h-[70vh] overflow-y-auto ios-scroll"><section id="tabSettings"><div class="grid grid-cols-1 sm:grid-cols-3 gap-3"><div><div class="text-xs text-slate-500 mb-1">季節</div><select id="seasonSel" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm"><option value="auto">Auto</option><option value="spring">春</option><option value="summer">夏</option><option value="autumn">秋</option><option value="winter">冬</option></select></div><div><div class="text-xs text-slate-500 mb-1">時間</div><select id="timeSel" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm"><option value="auto">Auto</option><option value="morning">朝</option><option value="day">昼</option><option value="evening">夕</option><option value="night">夜</option><option value="late">深夜</option></select></div><div><div class="text-xs text-slate-500 mb-1">天気</div><select id="weatherSel" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm"><option value="auto">Auto</option><option value="clear">晴れ</option><option value="rain">雨</option><option value="other">その他</option></select></div></div>
            <div class="mt-4 rounded-2xl border border-slate-200 bg-white p-4"><div class="text-sm font-semibold text-slate-800">ミックス（手動）</div><p class="mt-1 text-xs text-slate-600 leading-relaxed">鳥は「頻度」、風/水は「強さ」。0で静かに、100で多めに。設定は保存されます。</p><div class="mt-4 space-y-4"><div><div class="flex items-center justify-between"><div class="text-xs text-slate-500">鳥（頻度）</div><div id="birdVal" class="text-xs font-medium text-slate-700 tabular-nums">50</div></div><input id="birdMix" type="range" min="0" max="100" step="1" class="w-full" /></div><div><div class="flex items-center justify-between"><div class="text-xs text-slate-500">風（強さ）</div><div id="windVal" class="text-xs font-medium text-slate-700 tabular-nums">50</div></div><input id="windMix" type="range" min="0" max="100" step="1" class="w-full" /></div><div><div class="flex items-center justify-between"><div class="text-xs text-slate-500">水（強さ）</div><div id="waterVal" class="text-xs font-medium text-slate-700 tabular-nums">50</div></div><input id="waterMix" type="range" min="0" max="100" step="1" class="w-full" /></div></div></div></section>
          <section id="tabGuide" class="hidden">
            <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
              <div class="text-sm font-semibold text-slate-800">このアプリの仕組み</div>
              <p class="mt-2 text-sm text-slate-700 leading-relaxed">
                自然の値をそのまま音量に結びつけるのではなく、心地よさのバランスを守りながら、
                キーやテンポ、光の明るさ、きらめきの密度へとそっと織り込んでいます。
              </p>
            </div>
          </section>
        </div></div></div>
  </div>

<script>
const OPEN_METEO_URL = "https://api.open-meteo.com/v1/forecast";
const AUTO_UPDATE_MS = 5 * 60 * 1000;
let nextUpdateAt = Date.now() + AUTO_UPDATE_MS;
function describeWeather(code){if(code===0)return"快晴";if([1,2].includes(code))return"晴れ/薄曇り";if(code===3)return"くもり";if([45,48].includes(code))return"霧";if([51,53,55,56,57].includes(code))return"霧雨";if([61,63,65,66,67].includes(code))return"雨";if([71,73,75,77].includes(code))return"雪";if([80,81,82].includes(code))return"にわか雨";if([95,96,99].includes(code))return"雷雨";return"不明";}
function weatherCategoryFromCode(code){if(code===0||[1,2].includes(code))return"clear";if([61,63,65,66,67,80,81,82,51,53,55,56,57,95,96,99].includes(code))return"rain";return"other";}
async function fetchWeatherByCoords(lat,lon){const url=new URL(OPEN_METEO_URL);url.searchParams.set("latitude",lat);url.searchParams.set("longitude",lon);url.searchParams.set("current","weather_code,wind_speed_10m");url.searchParams.set("daily","uv_index_max");url.searchParams.set("timezone","auto");const res=await fetch(url.toString());if(!res.ok)throw new Error("天気取得に失敗しました");const data=await res.json();const code=data?.current?.weather_code;const wind=data?.current?.wind_speed_10m;const uvArr=data?.daily?.uv_index_max;const uv=Array.isArray(uvArr)?uvArr[0]:null;if(typeof code!=="number"||typeof wind!=="number")throw new Error("天気データ形式が想定と違います");return {code,wind,uv:(typeof uv==="number"?uv:null)};}
function getCurrentPosition(){return new Promise((resolve,reject)=>{if(!navigator.geolocation)return reject(new Error("このブラウザは位置情報に対応していません"));navigator.geolocation.getCurrentPosition(resolve,reject,{enableHighAccuracy:false,timeout:8000,maximumAge:60_000});});}
let wakeLock=null; async function requestWakeLock(){try{if(!("wakeLock" in navigator))return;wakeLock=await navigator.wakeLock.request("screen");wakeLock.addEventListener("release",()=>{wakeLock=null;});}catch(e){}} async function releaseWakeLock(){try{if(wakeLock)await wakeLock.release();}catch(e){}wakeLock=null;} document.addEventListener("visibilitychange",async()=>{if(document.visibilityState==="visible"&&isRunning){await requestWakeLock();}});
const MIX_KEY="ambientMix_v1"; const mixState={bird:50,wind:50,water:50};
function clamp(n,min,max){return Math.max(min,Math.min(max,n));} function randomBetween(min,max){return min+Math.random()*(max-min);} function randInt(min,max){return Math.floor(min+Math.random()*(max-min+1));} function choose(arr){return arr[Math.floor(Math.random()*arr.length)];}
function loadMix(){try{const raw=localStorage.getItem(MIX_KEY);if(!raw)return;const obj=JSON.parse(raw);if(typeof obj?.bird==="number")mixState.bird=clamp(Math.round(obj.bird),0,100);if(typeof obj?.wind==="number")mixState.wind=clamp(Math.round(obj.wind),0,100);if(typeof obj?.water==="number")mixState.water=clamp(Math.round(obj.water),0,100);}catch(e){}}
function saveMix(){try{localStorage.setItem(MIX_KEY,JSON.stringify(mixState));}catch(e){}}
function mixMultiplierFromPercent(p){const x=clamp(p,0,100)/50;return clamp(x,0,2.0);} function getMix(){return {birdMul:mixMultiplierFromPercent(mixState.bird),windMul:mixMultiplierFromPercent(mixState.wind),waterMul:mixMultiplierFromPercent(mixState.water),birdPct:mixState.bird,windPct:mixState.wind,waterPct:mixState.water};}
function syncMixUI(){const b=document.getElementById("birdMix"),w=document.getElementById("windMix"),wa=document.getElementById("waterMix"),bv=document.getElementById("birdVal"),wv=document.getElementById("windVal"),wav=document.getElementById("waterVal");if(!b||!w||!wa||!bv||!wv||!wav)return;b.value=String(mixState.bird);w.value=String(mixState.wind);wa.value=String(mixState.water);bv.textContent=String(mixState.bird);wv.textContent=String(mixState.wind);wav.textContent=String(mixState.water);} function onMixChange(){syncMixUI();saveMix();if(isRunning){const r=applyParams();const now=Tone.now();if(windGain)windGain.gain.setValueAtTime(Math.max(0.000001,windBaseLevel(r)),now);if(waterGain)waterGain.gain.setValueAtTime(Math.max(0.000001,waterBaseLevel(r)),now);}}
function autoTimeBlock(){const h=new Date().getHours();if(h>=5&&h<10)return"morning";if(h>=10&&h<16)return"day";if(h>=16&&h<19)return"evening";if(h>=19&&h<24)return"night";return"late";} function autoSeason(){const m=new Date().getMonth()+1;if(m>=3&&m<=5)return"spring";if(m>=6&&m<=8)return"summer";if(m>=9&&m<=11)return"autumn";return"winter";}
function setStatus(main,sub="—"){const a=document.getElementById("statusMain"),b=document.getElementById("statusSub");if(!a||!b)return;a.textContent=main;b.textContent=sub;} function setStatusChip(text="—"){const el=document.getElementById("statusChip");if(el)el.textContent=text;}
function applyWhiteByTime(time){const map={morning:["from-sky-50","via-white","to-slate-100"],day:["from-white","via-white","to-slate-100"],evening:["from-amber-50","via-white","to-rose-100"],night:["from-slate-50","via-white","to-slate-200"],late:["from-slate-50","via-white","to-slate-200"]};const [a,b,c]=map[time]||map.day;document.body.className=`min-h-screen text-slate-900 bg-gradient-to-b ${a} ${b} ${c}`;}
function setMediaSessionMetadata(text){if(!("mediaSession" in navigator))return;try{navigator.mediaSession.metadata=new MediaMetadata({title:"Ambient Music",artist:text,album:"Nature Sync"});navigator.mediaSession.setActionHandler("play",async()=>{if(!isRunning)await start();});navigator.mediaSession.setActionHandler("pause",()=>{if(isRunning)stop();});}catch(e){}}
function updatePlaybackState(){if(!("mediaSession" in navigator))return;try{navigator.mediaSession.playbackState=isRunning?"playing":"paused";}catch(e){}}
let isRunning=false;
let masterReverb, masterComp, masterLimiter;
let filter, airHighpass, airChorus;
let sparkle, crystalLead, stringPad, padGain; let bird,birdFilter,birdTremolo; let windNoise,windFilter,windGain; let waterNoise,waterFilter,waterGain;
let sparkleMulti=null,sparkleAutoPanner=null,sparkleHitPanner=null;
let sparkleLoop,birdLoop,windLoop,waterLoop,melodyLoop,padLoop,chordEventId=null;
let harmonySlots=null,harmonySlotIndex=0;
let lastWeather={code:0,wind:0,uv:null}; let lastRoot=null;
const SEASON_SOUND_PROFILE={spring:{brightness:0.1,padAttack:1.06,shimmer:0.22,calm:0.1},summer:{brightness:0.18,padAttack:0.94,shimmer:0.30,calm:0.02},autumn:{brightness:-0.06,padAttack:1.12,shimmer:0.14,calm:0.18},winter:{brightness:0.05,padAttack:1.16,shimmer:0.26,calm:0.24}};
const TIME_SOUND_PROFILE={morning:{density:0.08,space:0.08,brightness:0.10},day:{density:0.14,space:0,brightness:0.15},evening:{density:-0.04,space:0.14,brightness:-0.02},night:{density:-0.12,space:0.20,brightness:-0.08},late:{density:-0.18,space:0.28,brightness:-0.12}};
const WEATHER_SOUND_PROFILE={clear:{brightness:0.20,wet:-0.05,decay:-1.8,reflect:0.22},rain:{brightness:-0.14,wet:0.08,decay:2.2,reflect:-0.10},other:{brightness:0,wet:0,decay:0,reflect:0}};
function ensureAudioGraph(){if(sparkle)return;masterReverb=new Tone.Reverb({decay:14.5,wet:0.42}).toDestination();masterComp=new Tone.Compressor({threshold:-18,ratio:2.2,attack:0.01,release:0.22}).connect(masterReverb);masterLimiter=new Tone.Limiter(-1).connect(masterComp);airChorus=new Tone.Chorus({frequency:0.18,delayTime:3.2,depth:0.12,spread:120,wet:0.16}).start();airHighpass=new Tone.Filter({type:"highpass",frequency:90,rolloff:-12}).connect(airChorus);filter=new Tone.Filter({type:"lowpass",frequency:1900,rolloff:-12}).connect(airHighpass);airChorus.connect(masterLimiter);sparkleAutoPanner=new Tone.AutoPanner({frequency:0.10,depth:0.85,wet:1.0}).start();sparkleHitPanner=new Tone.Panner(0);sparkleAutoPanner.connect(sparkleHitPanner);sparkleHitPanner.connect(filter);sparkle=new Tone.FMSynth({oscillator:{type:"triangle"},modulation:{type:"sine"},harmonicity:2.0,modulationIndex:2.8,envelope:{attack:0.008,decay:0.12,sustain:0,release:1.35},modulationEnvelope:{attack:0.01,decay:0.16,sustain:0,release:0.8}});sparkle.volume.value=-15;crystalLead=new Tone.FMSynth({oscillator:{type:"triangle"},modulation:{type:"sine"},harmonicity:2.4,modulationIndex:1.8,envelope:{attack:0.35,decay:1.2,sustain:0.25,release:4.8},modulationEnvelope:{attack:0.25,decay:1.1,sustain:0.12,release:2.6}}).connect(filter);crystalLead.volume.value=-22;padGain=new Tone.Gain(0.000001).connect(filter);stringPad=new Tone.PolySynth(Tone.Synth,{oscillator:{type:"triangle"},envelope:{attack:3.2,decay:1.6,sustain:0.86,release:14.0}}).connect(padGain);stringPad.volume.value=-23;birdTremolo=new Tone.Tremolo({frequency:9,depth:0.65,wet:1.0}).start();birdFilter=new Tone.Filter({type:"bandpass",frequency:2300,Q:6});bird=new Tone.Synth({oscillator:{type:"sine"},envelope:{attack:0.004,decay:0.07,sustain:0,release:0.17}});bird.chain(birdTremolo,birdFilter,filter);bird.volume.value=-19;windNoise=new Tone.Noise("pink").start();windFilter=new Tone.Filter({type:"bandpass",frequency:420,Q:0.9});windGain=new Tone.Gain(0.000001);windNoise.chain(windFilter,windGain,filter);waterNoise=new Tone.Noise("brown").start();waterFilter=new Tone.Filter({type:"lowpass",frequency:900,rolloff:-12});waterGain=new Tone.Gain(0.000001);waterNoise.chain(waterFilter,waterGain,filter);if(!harmonySlots){harmonySlots=[0,1].map(()=>{const g=new Tone.Gain(0.000001).connect(filter);const s=new Tone.PolySynth(Tone.FMSynth,{oscillator:{type:"triangle"},modulation:{type:"sine"},harmonicity:1.5,modulationIndex:1.4,envelope:{attack:2.4,decay:0.7,sustain:0.8,release:18},modulationEnvelope:{attack:0.4,decay:0.8,sustain:0.3,release:3.2}}).connect(g);s.volume.value=-18;return {synth:s,gain:g};});}}
function keyFromSeason(season){if(season==="spring")return"C";if(season==="summer")return"D";if(season==="autumn")return"Eb";if(season==="winter")return"A";return"C";} function chordChoicesForKey(key){const map={"C":["C4","F4","G4","A4"],"D":["D4","G4","A4","B4"],"Eb":["Eb4","Ab4","Bb4","C5"],"A":["A3","D4","E4","F#4"]};return map[key]||map["C"];}
function triad(rootNote){const r=Tone.Frequency(rootNote);return [r.toNote(),r.transpose(4).toNote(),r.transpose(7).toNote()];}
function sparkleScale(key,weatherCat,time){const major={"C":["C5","D5","E5","F5","G5","A5","B5","C6"],"D":["D5","E5","F#5","G5","A5","B5","C#6","D6"],"Eb":["Eb5","F5","G5","Ab5","Bb5","C6","D6","Eb6"],"A":["A4","B4","C#5","D5","E5","F#5","G#5","A5"]};const pent={"C":["C5","D5","E5","G5","A5","C6"],"D":["D5","E5","F#5","A5","B5","D6"],"Eb":["Eb5","F5","G5","Bb5","C6","Eb6"],"A":["A4","B4","C#5","E5","F#5","A5"]};const usePent=(weatherCat==="rain")||(time==="night"||time==="late");return usePent?(pent[key]||pent["C"]):(major[key]||major["C"]);}function melodyScaleForKey(key){const map={"C":["C4","D4","E4","G4","A4","C5","E5"],"D":["D4","E4","F#4","A4","B4","D5","F#5"],"Eb":["Eb4","F4","G4","Bb4","C5","Eb5","G5"],"A":["A3","B3","C#4","E4","F#4","A4","C#5"]};return map[key]||map["C"];}function melodyDuration(r){let d=randomBetween(1.8,4.8);if(r.time==="night"||r.time==="late")d*=1.25;if(r.weatherCat==="clear")d*=0.9;return clamp(d,1.4,6.8);}
function getEnv(){const seasonSel=document.getElementById("seasonSel").value,timeSel=document.getElementById("timeSel").value,weatherSel=document.getElementById("weatherSel").value;const season=(seasonSel==="auto")?autoSeason():seasonSel;const time=(timeSel==="auto")?autoTimeBlock():timeSel;const weatherCat=(weatherSel==="auto")?weatherCategoryFromCode(lastWeather.code):weatherSel;return {season,time,weatherCat};}
function prettyTimeLabel(t){if(t==="morning")return"朝";if(t==="day")return"昼";if(t==="evening")return"夕";if(t==="night")return"夜";if(t==="late")return"深夜";return t;} function prettyWeatherLabel(w){if(w==="clear")return"晴れ";if(w==="rain")return"雨";if(w==="other")return"その他";return w;}
function isDayTimeBlock(time){return(time==="day"||time==="morning"||time==="evening");}
function applyParams(){const env=getEnv();const key=keyFromSeason(env.season);applyWhiteByTime(env.time);let bpm=66;if(env.time==="morning")bpm=74;if(env.time==="day")bpm=78;if(env.time==="evening")bpm=70;if(env.time==="night")bpm=60;if(env.time==="late")bpm=54;Tone.Transport.bpm.value=bpm;const seasonFx=SEASON_SOUND_PROFILE[env.season]||SEASON_SOUND_PROFILE.spring;const timeFx=TIME_SOUND_PROFILE[env.time]||TIME_SOUND_PROFILE.day;const weatherFx=WEATHER_SOUND_PROFILE[env.weatherCat]||WEATHER_SOUND_PROFILE.other;const windNorm=clamp((lastWeather.wind??0)/15,0,1);let cutoff=1950+980*weatherFx.brightness+560*seasonFx.brightness+460*timeFx.brightness;let wet=0.42+weatherFx.wet+0.04*timeFx.space;let decay=14.5+weatherFx.decay+4.0*timeFx.space+1.6*seasonFx.calm;const uvRaw=(typeof lastWeather.uv==="number")?lastWeather.uv:null;const showUv=(uvRaw!==null)&&isDayTimeBlock(env.time);const uvText=showUv?uvRaw.toFixed(1):"—";if(showUv){const u=clamp(uvRaw/11,0,1);cutoff+=560*u;wet-=0.06*u;decay-=1.2*u;}filter.frequency.value=clamp(cutoff,950,3600);masterReverb.wet.value=clamp(wet,0.28,0.70);masterReverb.decay=clamp(decay,9.0,20.0);if(birdFilter){birdFilter.frequency.value=clamp(2050+560*weatherFx.reflect+220*timeFx.brightness,1700,2950);}if(sparkleAutoPanner){let f=0.10;if(env.time==="day")f=0.13;if(env.time==="morning")f=0.12;if(env.time==="evening")f=0.11;if(env.time==="night")f=0.085;if(env.time==="late")f=0.070;sparkleAutoPanner.frequency.value=f;sparkleAutoPanner.depth=clamp(0.70+0.12*weatherFx.reflect+0.11*windNorm,0.62,0.92);}if(airHighpass){airHighpass.frequency.value=clamp(72+52*seasonFx.brightness+42*windNorm,60,155);}if(airChorus){airChorus.depth=clamp(0.10+0.16*seasonFx.shimmer+0.14*windNorm,0.08,0.22);airChorus.wet.value=clamp(0.12+0.08*timeFx.space+0.08*weatherFx.reflect,0.10,0.24);airChorus.frequency.value=clamp(0.15+0.28*windNorm,0.12,0.45);}if(sparkle){sparkle.harmonicity.value=clamp(1.7+0.7*seasonFx.shimmer+0.5*windNorm,1.4,3.1);sparkle.modulationIndex.value=clamp(2.1+1.2*weatherFx.reflect+0.9*windNorm,1.4,4.2);}if(harmonySlots){const hAttack=clamp(2.2*seasonFx.padAttack*(1+0.28*timeFx.space),1.9,4.8);const hRelease=clamp(16.5+4.2*timeFx.space+2.0*seasonFx.calm,14.0,23.0);const hHarmonicity=clamp(1.35+0.45*seasonFx.shimmer+0.22*weatherFx.reflect,1.2,2.3);harmonySlots.forEach(slot=>{slot.synth.set({harmonicity:hHarmonicity,modulationIndex:clamp(1.2+0.4*weatherFx.reflect,1.0,2.0),envelope:{attack:hAttack,decay:0.7,sustain:0.8,release:hRelease},modulationEnvelope:{attack:0.4,decay:0.8,sustain:0.3,release:clamp(2.8+timeFx.space*1.6,2.8,4.4)}});});}if(windFilter){windFilter.frequency.value=clamp(340+120*weatherFx.reflect+90*windNorm,280,520);windFilter.Q.value=clamp(0.82+0.26*windNorm+(env.time==="late"?0.14:0),0.78,1.22);}if(waterFilter){waterFilter.frequency.value=clamp(780+210*weatherFx.reflect+80*timeFx.space,680,1080);}const windText=`${(lastWeather.wind??0).toFixed(1)} m/s`;setMediaSessionMetadata(`${env.season} / ${env.weatherCat} / wind ${windText} / UV ${uvText}`);const sub=`Key ${key} · ${prettyTimeLabel(env.time)} · ${prettyWeatherLabel(env.weatherCat)} · 風 ${(lastWeather.wind??0).toFixed(1)} · UV ${uvText}`;setStatusChip(describeWeather(lastWeather.code));if(isRunning)setStatus("再生中",sub);return {...env,key,bpm,seasonFx,timeFx,weatherFx,windNorm};}
function clearHarmonyScheduler(){if(chordEventId!==null){try{Tone.Transport.clear(chordEventId);}catch(e){} chordEventId=null;}}
function harmonyGapSeconds(r){let g=randomBetween(0.55,2.1);const burstChance=(r.time==="day"||r.time==="morning")?0.30:(r.time==="evening")?0.24:(r.time==="night")?0.16:0.12;if(Math.random()<burstChance){g*=randomBetween(0.20,0.46);}if(r.time==="late")g*=1.12;if(r.time==="night")g*=1.04;if(r.weatherCat==="rain")g*=1.05;return clamp(g,0.22,3.3);} function octaveShifted(note,octShift){const f=Tone.Frequency(note);return f.transpose(12*octShift).toNote();}
function pickOverlapMode(r){let base=0.52;if(r.time==="day"||r.time==="morning")base=0.60;if(r.time==="evening")base=0.54;if(r.time==="night")base=0.44;if(r.time==="late")base=0.32;if(r.weatherCat==="rain")base*=0.92;if(Math.random()>=base)return"none";let earlyWeight=0.78;if(r.time==="late")earlyWeight=0.62;if(r.time==="night")earlyWeight=0.70;if(r.weatherCat==="rain")earlyWeight*=0.95;return(Math.random()<earlyWeight)?"early":"tail";}
function playOneHarmony(startTime,r){if(!harmonySlots)return;const choices=chordChoicesForKey(r.key);let root=choices[Math.floor(Math.random()*choices.length)];if(root===lastRoot)root=choices[Math.floor(Math.random()*choices.length)];lastRoot=root;const playDur=randomBetween(26.0,52.0);const gapDur=harmonyGapSeconds(r);let oct=choose([-1,0,0,0,+1,+1]);if(Math.random()<0.10)oct=choose([-2,+2]);const shiftedRoot=octaveShifted(root,oct);const slot=harmonySlots[harmonySlotIndex%harmonySlots.length];harmonySlotIndex++;const chordGain=slot.gain;const chordPad=slot.synth;let peak=0.15+Math.random()*0.17;if(r.time==="night"||r.time==="late")peak*=0.78;if(r.weatherCat==="rain")peak*=0.86;peak*=(1+(r.timeFx?.density??0)*0.22);peak*=(1+(r.seasonFx?.shimmer??0)*0.12);const t0=startTime,tPeak=startTime+playDur*(0.35+Math.random()*0.35),tEnd=startTime+playDur;chordGain.gain.cancelScheduledValues(t0);chordGain.gain.setValueAtTime(Math.max(0.000001,chordGain.gain.value),t0);chordGain.gain.exponentialRampToValueAtTime(Math.max(0.00018,peak),tPeak);chordGain.gain.exponentialRampToValueAtTime(0.00012,tEnd);chordPad.triggerAttackRelease(triad(shiftedRoot),playDur,startTime,0.72);const mode=pickOverlapMode(r);let nextTime=startTime+playDur+gapDur;if(mode==="tail"){nextTime=tEnd+randomBetween(-10.0,6.0);nextTime=Math.max(nextTime,startTime+7.0);}else if(mode==="early"){const frac=randomBetween(0.30,0.70);nextTime=startTime+playDur*frac;} chordEventId=Tone.Transport.scheduleOnce((t)=>{const rr=applyParams();playOneHarmony(t,rr);},nextTime);}
function buildMultiTapDelay(){if(sparkleMulti){sparkleMulti.tapNodes.forEach(n=>{try{n.dispose();}catch(e){}});try{sparkleMulti.input.dispose();}catch(e){}try{sparkleMulti.merger.dispose();}catch(e){} sparkleMulti=null;}const taps=randInt(4,7);const merger=new Tone.Gain(1).connect(sparkleAutoPanner);const wetBase=randomBetween(0.40,0.62);const tapNodes=[];for(let i=0;i<taps;i++){const dt=randomBetween(0.03,0.23),fb=randomBetween(0.18,0.44)*(1-i*0.08),wt=clamp(wetBase*(0.85-i*0.06),0.18,0.65);const d=new Tone.FeedbackDelay({delayTime:dt,feedback:fb,wet:wt});d.connect(merger);tapNodes.push(d);}const input=new Tone.Gain(1);tapNodes.forEach(d=>input.connect(d));sparkleMulti={input,tapNodes,merger};return sparkleMulti;}
function pickSparkleDelayRefreshChance(r){if(r.time==="day")return 0.06;if(r.time==="morning")return 0.05;if(r.time==="evening")return 0.04;if(r.time==="night")return 0.03;return 0.02;} function rebuildSparkleDelayIfNeeded(r){if(!sparkleMulti){buildMultiTapDelay();sparkle.disconnect();sparkle.connect(sparkleMulti.input);return;}if(Math.random()<pickSparkleDelayRefreshChance(r)){buildMultiTapDelay();sparkle.disconnect();sparkle.connect(sparkleMulti.input);}}
function randomRhythmDuration(r){const dayish=(r.time==="morning"||r.time==="day"),nightish=(r.time==="night"||r.time==="late");const short=["32n","16n","16t"],mid=["24n","8t","12n"],long=["8n","4n","6n"];let pool=[...short,...mid];if(dayish)pool=[...short,...short,...mid,"16n"];if(nightish)pool=[...mid,...long,...mid];if(r.weatherCat==="rain")pool=[...pool,...long];const d=choose(pool),sec=Tone.Time(d).toSeconds();return clamp(sec,0.05,0.60);} function applyHitPan(time,r){if(!sparkleHitPanner)return;let width=0.85;if(r.weatherCat==="rain")width=0.70;if(r.time==="night")width=0.62;if(r.time==="late")width=0.52;if(r.time==="day")width=0.92;const target=(Math.random()*2-1)*width;sparkleHitPanner.pan.cancelScheduledValues(time);sparkleHitPanner.pan.setValueAtTime(sparkleHitPanner.pan.value,time);sparkleHitPanner.pan.linearRampToValueAtTime(target,time+0.06);}
function windBaseLevel(r){const mix=getMix();const w=clamp(lastWeather.wind??0,0,15);let base=0.00006+0.00010*(w/15);if(r.time==="night")base*=0.78;if(r.time==="late")base*=0.65;if(r.weatherCat==="rain")base*=0.90;base*=mix.windMul;return clamp(base,0.000001,0.00035);} function waterBaseLevel(r){const mix=getMix();let base=0.00004;if(r.weatherCat==="rain")base=0.00008;if(r.time==="night")base*=0.85;if(r.time==="late")base*=0.70;base*=mix.waterMul;return clamp(base,0.000001,0.00030);} function triggerWindGust(time,r){if(!windGain)return;const base=windBaseLevel(r),peak=clamp(base*randomBetween(2.0,4.8),0.00001,0.00090),dur=randomBetween(2.4,6.8);windGain.gain.cancelScheduledValues(time);windGain.gain.setValueAtTime(Math.max(0.000001,windGain.gain.value),time);windGain.gain.exponentialRampToValueAtTime(Math.max(0.000001,peak),time+0.7);windGain.gain.exponentialRampToValueAtTime(Math.max(0.000001,base),time+dur);} function triggerWaterRipple(time,r){if(!waterGain)return;const base=waterBaseLevel(r),peak=clamp(base*randomBetween(1.6,3.2),0.00001,0.00085),dur=randomBetween(1.4,4.6);waterGain.gain.cancelScheduledValues(time);waterGain.gain.setValueAtTime(Math.max(0.000001,waterGain.gain.value),time);waterGain.gain.exponentialRampToValueAtTime(Math.max(0.000001,peak),time+0.25);waterGain.gain.exponentialRampToValueAtTime(Math.max(0.000001,base),time+dur);}
function rebuildLoops(){Tone.Transport.cancel(0);if(sparkleLoop){sparkleLoop.dispose();sparkleLoop=null;}if(birdLoop){birdLoop.dispose();birdLoop=null;}if(windLoop){windLoop.dispose();windLoop=null;}if(waterLoop){waterLoop.dispose();waterLoop=null;}if(melodyLoop){melodyLoop.dispose();melodyLoop=null;}if(padLoop){padLoop.dispose();padLoop=null;}clearHarmonyScheduler();const r=applyParams();const now=Tone.now();if(windGain)windGain.gain.setValueAtTime(Math.max(0.000001,windBaseLevel(r)),now);if(waterGain)waterGain.gain.setValueAtTime(Math.max(0.000001,waterBaseLevel(r)),now);const startAt=Tone.Transport.seconds+0.1;chordEventId=Tone.Transport.scheduleOnce((t)=>playOneHarmony(t,r),startAt);rebuildSparkleDelayIfNeeded(r);const sparkleInterval=0.52;sparkleLoop=new Tone.Loop((time)=>{rebuildSparkleDelayIfNeeded(r);const scale=sparkleScale(r.key,r.weatherCat,r.time);let p=0.60;if(r.weatherCat==="rain")p=0.50;if(r.time==="late")p=0.36;if(r.time==="night")p=Math.min(p,0.44);if(r.weatherCat==="clear"&&(r.time==="day"||r.time==="morning"))p=0.70;p+=(r.seasonFx?.shimmer??0)*0.07;p+=(r.timeFx?.density??0)*0.18;p+=(r.weatherFx?.reflect??0)*0.08;const windBoost=clamp(((lastWeather.wind??0)-2)/10,0,0.14);p+=windBoost;const uvRaw=(typeof lastWeather.uv==="number")?lastWeather.uv:null;if(uvRaw!==null&&(r.time==="day"||r.time==="morning")){const u=clamp(uvRaw/11,0,1);p+=0.12*u;}p=clamp(p,0.14,0.82);if(Math.random()<p){applyHitPan(time,r);const note=scale[Math.floor(Math.random()*scale.length)];const durSec=clamp(randomRhythmDuration(r)*(1+(r.timeFx?.space??0)*0.25),0.05,0.66);const amp=0.36+Math.random()*0.11;if(Math.random()<0.16){const note2=scale[Math.floor(Math.random()*scale.length)],dur2=clamp(durSec*randomBetween(0.75,1.15),0.05,0.55);sparkle.triggerAttackRelease(note,durSec,time,amp);sparkle.triggerAttackRelease(note2,dur2,time+0.02,amp*0.82);}else sparkle.triggerAttackRelease(note,durSec,time,amp);}},sparkleInterval).start(0);
function birdChance(){const mix=getMix();let base=0.08;if(r.time==="morning")base=0.18;if(r.time==="day")base=0.26;if(r.time==="evening")base=0.14;if(r.time==="night")base=0.04;if(r.time==="late")base=0.018;if(r.weatherCat==="rain")base*=0.70;if(r.weatherCat==="clear"&&(r.time==="day"||r.time==="morning"))base*=1.10;const w=clamp(lastWeather.wind??0,0,15);base*=(1+0.12*(w/15));const uvRaw=(typeof lastWeather.uv==="number")?lastWeather.uv:null;if(uvRaw!==null&&r.time==="day"){const u=clamp(uvRaw/11,0,1);base*=(1+0.12*u);}base*=mix.birdMul;return clamp(base,0.0,0.55);} function chirp(time,amp=0.30){const base=1450+Math.random()*700,up=base+980+Math.random()*560,dur=0.055+Math.random()*0.070;bird.frequency.setValueAtTime(base,time);bird.frequency.linearRampToValueAtTime(up,time+dur);bird.frequency.linearRampToValueAtTime(base+240,time+dur+0.03);bird.triggerAttackRelease("C6",dur+0.06,time,amp);} function phrase(time){const n=(Math.random()<0.50)?2:(Math.random()<0.80?3:5);const baseGap=0.10+Math.random()*0.09;for(let i=0;i<n;i++){const t=time+i*(baseGap+Math.random()*0.06);chirp(t,0.26+Math.random()*0.12);}} function birdLoopIntervalSeconds(){if(r.time==="day")return 1.55;if(r.time==="morning")return 1.70;if(r.time==="evening")return 2.05;if(r.time==="night")return 2.80;return 3.40;}
birdLoop=new Tone.Loop((time)=>{if(!bird)return;const p=birdChance();if(Math.random()<p){if(r.time==="night"||r.time==="late"){chirp(time,0.23);if(Math.random()<0.22)chirp(time+0.16+Math.random()*0.10,0.21);return;}const roll=Math.random();if(roll<0.46){chirp(time,0.28+Math.random()*0.10);if(Math.random()<(r.time==="day"?0.62:0.46))chirp(time+0.12+Math.random()*0.12,0.24+Math.random()*0.10);}else if(roll<0.80){const n=(Math.random()<0.55)?2:4;for(let i=0;i<n;i++)chirp(time+i*(0.11+Math.random()*0.10),0.23+Math.random()*0.12);}else phrase(time);}},birdLoopIntervalSeconds()).start(0);
function windLoopInterval(){if(r.time==="day")return 3.2;if(r.time==="morning")return 3.6;if(r.time==="evening")return 4.0;if(r.time==="night")return 5.0;return 6.2;} windLoop=new Tone.Loop((time)=>{const mix=getMix();const w=clamp(lastWeather.wind??0,0,15);let p=0.20+0.35*(w/15);if(r.time==="late")p*=0.70;if(r.weatherCat==="rain")p*=0.90;p*=clamp(0.15+0.85*mix.windMul,0.0,2.0);p=clamp(p,0.0,0.78);if(Math.random()<p)triggerWindGust(time,r);},windLoopInterval()).start(0);
function waterLoopInterval(){if(r.weatherCat==="rain")return 3.0;if(r.time==="day")return 4.2;if(r.time==="morning")return 4.6;if(r.time==="evening")return 5.0;if(r.time==="night")return 6.2;return 7.2;} waterLoop=new Tone.Loop((time)=>{const mix=getMix();let p=(r.weatherCat==="rain")?0.44:0.26;if(r.time==="late")p*=0.75;if(r.time==="night")p*=0.85;p*=clamp(0.15+0.85*mix.waterMul,0.0,2.0);p=clamp(p,0.0,0.66);if(Math.random()<p)triggerWaterRipple(time,r);},waterLoopInterval()).start(0);
padLoop=new Tone.Loop((time)=>{if(!stringPad||!padGain)return;const roots=chordChoicesForKey(r.key);const root=choose(roots);const dur=randomBetween(18,34);const notes=triad(octaveShifted(root,-1));const base=0.00010+(r.time==="night"||r.time==="late"?0.00002:0.00005);padGain.gain.cancelScheduledValues(time);padGain.gain.setValueAtTime(Math.max(0.000001,padGain.gain.value),time);padGain.gain.exponentialRampToValueAtTime(base,time+4.0);padGain.gain.exponentialRampToValueAtTime(0.00002,time+dur);stringPad.triggerAttackRelease(notes,dur,time,0.28);},randomBetween(12,18)).start(0);
melodyLoop=new Tone.Loop((time)=>{if(!crystalLead)return;const mScale=melodyScaleForKey(r.key);const melodyOnlyChance=(r.time==="night"||r.time==="late")?0.42:0.22;const useMelodyOnly=Math.random()<melodyOnlyChance;const phraseLen=useMelodyOnly?(Math.random()<0.6?3:4):(Math.random()<0.5?2:3);for(let i=0;i<phraseLen;i++){const n=choose(mScale);const t=time+i*randomBetween(0.45,0.95);const d=melodyDuration(r)*(useMelodyOnly?1.18:0.82);const v=useMelodyOnly?0.36:0.28;crystalLead.triggerAttackRelease(n,d,t,v);}if(useMelodyOnly&&sparkle&&Math.random()<0.7){sparkle.volume.value=-24;}else if(sparkle){sparkle.volume.value=-15;}},randomBetween(3.4,6.2)).start(0);
}
function setButtonState(){const dot=document.getElementById("dot"),modeText=document.getElementById("modeText"),btn=document.getElementById("btnToggle"),label=document.getElementById("btnLabel"),sub=document.getElementById("btnSub"),iconSvg=document.getElementById("iconSvg");if(isRunning){dot.className="inline-block size-2 rounded-full bg-emerald-500";modeText.textContent="Playing";btn.classList.remove("bg-slate-900","hover:bg-slate-800");btn.classList.add("bg-rose-600","hover:bg-rose-500");label.textContent="Stop";sub.textContent="タップで停止";iconSvg.innerHTML='<path d="M6 6h5v12H6zM13 6h5v12h-5z"></path>';}else{dot.className="inline-block size-2 rounded-full bg-slate-400";modeText.textContent="Ready";btn.classList.remove("bg-rose-600","hover:bg-rose-500");btn.classList.add("bg-slate-900","hover:bg-slate-800");label.textContent="Start";sub.textContent="タップで再生";iconSvg.innerHTML='<path d="M8 5v14l11-7z"></path>';setStatusChip("—");setStatus("待機中","—");}updatePlaybackState();}
async function start(){ensureAudioGraph();Tone.Destination.mute=false;await Tone.start();await requestWakeLock();Tone.Transport.start();rebuildLoops();isRunning=true;setButtonState();applyParams();}
function stop(){isRunning=false;Tone.Destination.mute=true;clearHarmonyScheduler();if(sparkleLoop){sparkleLoop.stop();sparkleLoop.dispose();sparkleLoop=null;}if(birdLoop){birdLoop.stop();birdLoop.dispose();birdLoop=null;}if(windLoop){windLoop.stop();windLoop.dispose();windLoop=null;}if(waterLoop){waterLoop.stop();waterLoop.dispose();waterLoop=null;}if(melodyLoop){melodyLoop.stop();melodyLoop.dispose();melodyLoop=null;}if(padLoop){padLoop.stop();padLoop.dispose();padLoop=null;}Tone.Transport.stop();Tone.Transport.cancel(0);if(sparkleMulti){sparkleMulti.tapNodes.forEach(n=>{try{n.dispose();}catch(e){}});try{sparkleMulti.input.dispose();}catch(e){}try{sparkleMulti.merger.dispose();}catch(e){} sparkleMulti=null;}const now=Tone.now();try{if(windGain)windGain.gain.setValueAtTime(0.000001,now);if(waterGain)waterGain.gain.setValueAtTime(0.000001,now);if(harmonySlots){harmonySlots.forEach(s=>{try{s.gain.gain.cancelScheduledValues(now);}catch(e){}try{s.gain.gain.setValueAtTime(0.000001,now);}catch(e){}});}if(padGain){padGain.gain.setValueAtTime(0.000001,now);}if(sparkle){sparkle.volume.value=-15;}}catch(e){} setStatusChip(describeWeather(lastWeather.code));setStatus("停止中","—");setButtonState();releaseWakeLock();}
async function refreshWeather(){try{setStatusChip("—");setStatus("取得中…","天気/風/UV");const pos=await getCurrentPosition();const lat=pos.coords.latitude,lon=pos.coords.longitude;const {code,wind,uv}=await fetchWeatherByCoords(lat,lon);lastWeather={code,wind,uv};nextUpdateAt=Date.now()+AUTO_UPDATE_MS;applyParams();if(isRunning){rebuildLoops();applyParams();}else{const env=getEnv();const key=keyFromSeason(env.season);const uvRaw=(typeof lastWeather.uv==="number")?lastWeather.uv:null;const showUv=(uvRaw!==null)&&isDayTimeBlock(env.time);const uvText=showUv?uvRaw.toFixed(1):"—";const sub=`Key ${key} · ${prettyTimeLabel(env.time)} · ${prettyWeatherLabel(env.weatherCat)} · 風 ${(lastWeather.wind??0).toFixed(1)} · UV ${uvText}`;setStatusChip(describeWeather(lastWeather.code));setStatus("待機中",sub);}}catch(e){console.error(e);setStatusChip("—");setStatus("エラー",e.message);}}
function tick(){const remain=Math.max(0,nextUpdateAt-Date.now());const mm=String(Math.floor(remain/60000)).padStart(2,"0"),ss=String(Math.floor((remain%60000)/1000)).padStart(2,"0");document.getElementById("countdown").textContent=`${mm}:${ss}`;if(remain===0)refreshWeather();requestAnimationFrame(tick);} 
const settingsDetails=document.getElementById("settingsDetails"),settingsOverlay=document.getElementById("settingsOverlay"),settingsBackdrop=document.getElementById("settingsBackdrop"),btnCloseSettings=document.getElementById("btnCloseSettings");
const tabButtons=Array.from(document.querySelectorAll(".tabBtn")),tabSettings=document.getElementById("tabSettings"),tabGuide=document.getElementById("tabGuide"); function setTab(id){const isSettings=(id==="tabSettings");tabSettings.classList.toggle("hidden",!isSettings);tabGuide.classList.toggle("hidden",isSettings);tabButtons.forEach(btn=>{const active=btn.dataset.tab===id;btn.className="tabBtn flex-1 px-3 py-2 rounded-2xl text-sm border border-slate-200 "+(active?"bg-slate-900 text-white":"bg-white text-slate-700 hover:bg-slate-50");});}
function openSettings(){settingsOverlay.classList.remove("hidden");settingsDetails.open=false;document.documentElement.classList.add("overflow-hidden");document.body.classList.add("overflow-hidden");setTab("tabSettings");} function closeSettings(){settingsOverlay.classList.add("hidden");document.documentElement.classList.remove("overflow-hidden");document.body.classList.remove("overflow-hidden");}
settingsDetails.addEventListener("toggle",()=>{if(settingsDetails.open)openSettings();}); btnCloseSettings.addEventListener("click",closeSettings); settingsBackdrop.addEventListener("click",closeSettings); document.addEventListener("keydown",(e)=>{if(e.key==="Escape")closeSettings();}); tabButtons.forEach(btn=>btn.addEventListener("click",()=>setTab(btn.dataset.tab)));
document.getElementById("btnToggle").addEventListener("click",async()=>{if(!isRunning)await start();else stop();}); document.getElementById("btnRefresh").addEventListener("click",()=>refreshWeather()); ["seasonSel","timeSel","weatherSel"].forEach(id=>{document.getElementById(id).addEventListener("change",()=>{applyParams();if(isRunning)rebuildLoops();applyParams();});});
function bindMixSliders(){const b=document.getElementById("birdMix"),w=document.getElementById("windMix"),wa=document.getElementById("waterMix");if(!b||!w||!wa)return;b.addEventListener("input",()=>{mixState.bird=clamp(parseInt(b.value,10)||0,0,100);onMixChange();});w.addEventListener("input",()=>{mixState.wind=clamp(parseInt(w.value,10)||0,0,100);onMixChange();});wa.addEventListener("input",()=>{mixState.water=clamp(parseInt(wa.value,10)||0,0,100);onMixChange();});}
loadMix();syncMixUI();setButtonState();applyWhiteByTime(autoTimeBlock());refreshWeather();tick();bindMixSliders();
</script>
</body>
</html>
